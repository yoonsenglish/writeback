<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WriteBack</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        /* --- 기본 스타일 및 레이아웃 --- */
        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            line-height: 1.6;
            color: #334155;
        }

        #container {
            width: 100%;
            max-width: 768px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            position: relative;
            border: 1px solid #e2e8f0;
        }

        /* Reset 버튼 우측 정렬 스타일 */
        .header-section {
            position: relative;
            text-align: center;
            margin-bottom: 2rem;
        }

        .header-section h1 {
            margin-bottom: 0.5rem;
            color: #1e3a8a;
            font-size: 2.25rem;
            font-weight: 700;
        }

        #reset-btn {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #ef4444;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #reset-btn:hover {
            background-color: #dc2626;
        }

        /* --- 탭 개별 스타일 --- */
        nav {
            text-align: center;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }

        /* 공통 탭 스타일 */
        .tab-base {
            border: 2px solid transparent;
            padding: 0.8rem 1.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        /* 피드백 받기 탭 (파란색) */
        .tab-feedback {
            background-color: #e0e7ff;
            color: #3b82f6;
        }

        .tab-feedback.active {
            background-color: #1e40af;
            color: #ffffff;
            border: 3px solid #1e3a8a;
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.25);
            transform: translateY(-2px);
            font-weight: 700;
        }

        .tab-feedback:hover:not(.active) {
            background-color: #bfdbfe;
            color: #1e40af;
            border-color: #93c5fd;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.15);
        }

        .tab-feedback.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 4px;
            background-color: #ffffff;
            border-radius: 2px 2px 0 0;
        }

        /* 최종 결과물 생성 탭 (녹색) */
        .tab-final {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .tab-final.active {
            background-color: #16a34a;
            color: #ffffff;
            border: 3px solid #15803d;
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.25);
            transform: translateY(-2px);
            font-weight: 700;
        }

        .tab-final:hover:not(.active) {
            background-color: #bbf7d0;
            color: #15803d;
            border-color: #86efac;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.15);
        }

        .tab-final.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 4px;
            background-color: #ffffff;
            border-radius: 2px 2px 0 0;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 최종 결과물 페이지 녹색 테마 --- */
        #final-section.final-theme .input-area {
            background-color: #f0fdf4;
            border-color: #bbf7d0;
        }

        #final-section.final-theme .input-area:focus {
            border-color: #16a34a;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }

        #final-section.final-theme button:not(.icon-btn):not(#reset-btn) {
            background-color: #16a34a;
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.2);
        }

        #final-section.final-theme button:not(.icon-btn):not(#reset-btn):hover {
            background-color: #15803d;
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.3);
        }

        #final-section.final-theme .user-info input {
            border-color: #bbf7d0;
            background-color: #f0fdf4;
        }

        #final-section.final-theme .user-info input:focus {
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }

        /* --- 사용자 정보 입력 --- */
        .user-info {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }

        .user-info input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            color: #475569;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .user-info input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* --- 입력 영역 --- */
        .input-area {
            width: 100%;
            min-height: 180px;
            padding: 1.25rem;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            background-color: #f8fafc;
            resize: vertical;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1.05rem;
            line-height: 1.7;
            color: #334155;
        }

        .input-area:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

        .input-area.has-image {
            background-color: #eff6ff;
            border-color: #2563eb;
        }

        /* --- 아이콘 버튼 --- */
        .action-icons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .icon-btn-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 10px;
            background-color: #ffffff;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 1.5rem;
            color: #64748b;
        }

        .icon-btn:hover {
            background-color: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .icon-btn input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .icon-btn-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }

        /* --- 파일 정보 & OCR 상태 --- */
        .file-info,
        .ocr-status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-info {
            background-color: #e0f2fe;
            border: 1px solid #93c5fd;
            color: #1d4ed8;
            display: none;
        }

        .file-info.show {
            display: flex;
        }

        .file-info .file-name {
            flex: 1;
            font-weight: 500;
        }

        .ocr-status {
            background-color: #fefce8;
            border: 1px solid #fde68a;
            color: #b45309;
            display: none;
        }

        .ocr-status.show {
            display: flex;
        }

        .ocr-status .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #b45309;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- 일반 버튼 --- */
        button:not(.icon-btn):not(#reset-btn):not(.tab-feedback):not(.tab-final),
        a.button {
            background-color: #3b82f6;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 0.85rem 1.8rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-top: 1.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        button:hover:not(.icon-btn):not(#reset-btn):not(.tab-feedback):not(.tab-final),
        a.button:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        }
        
        button:disabled, a.button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- 버튼 그룹 --- */
        .btn-group {
            text-align: right;
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .btn-group button {
            margin-top: 0;
            background-color: #64748b;
            box-shadow: none;
        }

        .btn-group button:hover {
            background-color: #475569;
            transform: translateY(-2px);
        }

        .edit-save-btn {
            background-color: #64748b !important;
        }

        .edit-save-btn:hover {
            background-color: #475569 !important;
        }

        /* --- 스피너 (TTS) --- */
        .spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 3px solid #ffffff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 0.8rem;
        }

        #tts-spinner {
            border-color: #3b82f6;
            border-top-color: transparent;
        }

        /* --- 결과 박스 --- */
        .box,
        .model-box {
            background-color: #f1f5f9;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid #e2e8f0;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .box h2,
        .model-box h2 {
            margin: 0 0 1rem;
            color: #1e3a8a;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .model-box {
            background-color: #ffffff;
            font-size: 1.1rem;
            line-height: 1.8;
            border: 1px solid #d1d5db;
        }

        /* --- Edit 안내 문구 --- */
        .edit-instruction {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #1e40af;
            text-align: center;
        }

        /* --- 피드백 카테고리 스타일 --- */
        .feedback-container {
            margin-top: 1rem;
        }

        .feedback-category {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
        }

        .feedback-category:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .feedback-category h3 {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            margin-top: 0;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .feedback-category h3 i {
            margin-right: 8px;
            font-size: 1.4rem;
        }

        /* 총평 스타일 개선 */
        .overview-category {
            background-color: #f5f3ff;
            border-left: 5px solid #8b5cf6;
            padding: 15px 20px; /* 좌측 패딩 증가 */
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .overview-category h3 {
            display: flex;
            align-items: center;
            color: #5b21b6;
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .overview-category h3 i {
            margin-right: 10px;
        }

        .overview-category .content {
            margin-left: 10px; /* 내용 좌측 여백 추가 */
            line-height: 1.6;
        }

        /* 피드백 카테고리별 색상 */
        .grammar {
            background-color: #fdeded;
            border-left: 5px solid #e74c3c;
        }

        .vocabulary {
            background-color: #ebf5fb;
            border-left: 5px solid #3498db;
        }

        .expression {
            background-color: #f4ecf7;
            border-left: 5px solid #9b59b6;
        }

        .strengths {
            background-color: #ebfaf0;
            border-left: 5px solid #2ecc71;
        }

        /* 원문 인용 스타일 */
        .original-text {
            background-color: rgba(255, 255, 255, 0.7);
            border-left: 3px solid #94a3b8;
            padding: 10px 15px;
            margin: 10px 0;
            font-style: italic;
            color: #475569;
            border-radius: 4px;
        }

        .original-text::before {
            content: '원문';
            display: block;
            font-weight: 600;
            font-style: normal;
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: #64748b;
        }

        .feedback-point {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        /* 수정글 섹션 스타일 */
        .corrected-section {
            background-color: #ecfdf5;
            border-left: 5px solid #10b981;
            padding: 15px 20px;
            margin-top: 30px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .corrected-section h3 {
            display: flex;
            align-items: center;
            color: #047857;
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .corrected-section h3 i {
            margin-right: 10px;
        }

        .corrected-content {
            background-color: #ffffff;
            padding: 18px;
            border-radius: 6px;
            line-height: 1.8;
            font-size: 1.05rem;
            color: #1f2937;
            border: 1px solid #d1fae5;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
        }

        /* --- 인라인 Print 옵션 --- */
        .print-options-inline {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .print-options-inline label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
        }

        .print-options-inline input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }
        
        .print-options-inline button {
            margin-top: 0;
            margin-left: auto;
            background-color: #10b981;
        }

        .print-options-inline button:hover {
            background-color: #059669;
        }

        /* --- 최종 산출물 코너 특정 스타일 --- */
        #final-section .button-area {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 1.5rem;
        }

        #final-section .audio-controls-area {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
            width: 100%;
        }

        #final-section #tts-play-btn {
            width: fit-content;
            margin-top: 0;
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
            background-color: #6366f1;
        }

        #final-section #tts-play-btn:hover {
            background-color: #4f46e5;
        }

        #final-section #tts-audio-final {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #a78bfa;
            background-color: #f5f3ff;
            outline: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        #final-section #tts-download-btn {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 0;
            display: inline-block;
            transition: color 0.2s ease-in-out;
            margin-top: -0.5rem;
        }

        #final-section #tts-download-btn:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        #final-section .print-button-bottom {
            margin-top: 2.5rem;
            text-align: left;
            width: 100%;
        }
        
        #final-section .print-button-bottom .button {
            width: fit-content;
        }

        /* 모바일 반응형 디자인 */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            #container {
                padding: 1.5rem;
                margin: 0;
                max-width: 100%;
                box-shadow: none;
                border-radius: 8px;
            }
            
            .header-section h1 {
                font-size: 1.6rem;
                margin-bottom: 0.3rem;
                line-height: 1.3;
                padding-right: 100px;
            }
            
            #reset-btn {
                position: absolute;
                top: 0;
                right: 0;
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .user-info input {
                width: 100%;
                padding: 0.8rem;
                font-size: 1rem;
                border-radius: 6px;
            }
            
            nav {
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1.5rem;
            }
            
            .tab-base {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
                width: 100%;
                text-align: center;
            }
            
            .input-area {
                min-height: 150px;
                padding: 1rem;
                font-size: 1rem;
            }
            
            .action-icons {
                justify-content: center;
                gap: 1rem;
                flex-wrap: wrap;
            }
            
            .icon-btn-container {
                gap: 0.3rem;
            }
            
            .icon-btn {
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
            }
            
            .icon-btn-label {
                font-size: 0.8rem;
            }
            
            button:not(.icon-btn):not(#reset-btn):not(.tab-feedback):not(.tab-final),
            a.button {
                padding: 0.9rem 1.5rem;
                font-size: 1rem;
                width: 100%;
                margin-top: 1rem;
            }
            
            .feedback-category,
            .overview-category {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .feedback-category h3,
            .overview-category h3 {
                font-size: 1.1rem;
            }
            
            .print-options-inline {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .print-options-inline button {
                width: 100%;
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
            }
            
            #container {
                padding: 1rem;
            }
            
            .header-section h1 {
                font-size: 1.4rem;
                padding-right: 90px;
            }
            
            #reset-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .tab-base {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .input-area {
                min-height: 120px;
                padding: 0.75rem;
            }
        }

        /* 인쇄 스타일 */
        @media print {
            nav, button, a.button, #reset-btn, .action-icons, .btn-group,
            .print-options-inline, #tts-audio-final + #tts-download-btn {
                display: none !important;
            }
            body {
                background-color: #ffffff;
                margin: 0;
                padding: 1rem;
                color: #000000;
                font-family: serif;
            }
            #container {
                box-shadow: none;
                border: none;
                padding: 0;
                max-width: 100%;
            }
            h1, h2 {
                color: #000000 !important;
                text-align: left;
            }
            .box, .model-box {
                background-color: #ffffff;
                border: 1px solid #cccccc;
                padding: 1rem;
                margin-top: 1rem;
                box-shadow: none;
            }
            .user-info {
                display: block;
                margin-bottom: 1rem;
            }
            .user-info input {
                border: none;
                padding: 0;
                margin-bottom: 0.5rem;
            }
            .input-area {
                border: 1px dashed #cccccc;
                background-color: #ffffff;
                padding: 1rem;
                min-height: auto;
            }
            .feedback-category, .overview-category, .corrected-section {
                page-break-inside: avoid;
                border-left-width: 5px !important;
                background-color: #ffffff !important;
                color: #000000 !important;
                box-shadow: none !important;
                margin-bottom: 15px !important;
                padding: 10px 15px !important;
                border-radius: 0 !important;
            }
            .grammar { border-left-color: #e74c3c !important; }
            .vocabulary { border-left-color: #3498db !important; }
            .expression { border-left-color: #9b59b6 !important; }
            .strengths { border-left-color: #2ecc71 !important; }
            .overview-category { border-left-color: #8b5cf6 !important; }
            .corrected-section { border-left-color: #10b981 !important; }
            .original-text {
                background-color: #f8fafc !important;
                border-left: 3px solid #94a3b8 !important;
                padding: 10px !important;
                margin: 10px 0 !important;
                font-style: italic !important;
            }
            .feedback-category h3, .overview-category h3, .corrected-section h3 {
                font-weight: bold !important;
                margin-top: 0 !important;
                margin-bottom: 10px !important;
            }
            .edit-instruction {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div id="container">
        <div class="header-section">
            <h1>✨ 윤선생 리얼스피치 WriteBack ✨</h1>
            <button id="reset-btn">Reset</button>
        </div>

        <nav>
            <button id="tab-feedback" class="tab-base tab-feedback active">피드백 받기</button>
            <button id="tab-final" class="tab-base tab-final">최종 결과물 생성</button>
        </nav>

        <section id="feedback-section" class="section active">
            <form id="feedback-form">
                <label for="contentText-feedback">❇️영작한 내용을 입력하거나 찍어서 업로드해 주세요.</label>
                <div class="user-info">
                    <input type="text" id="user-name-feedback" placeholder="이름" />
                    <input type="text" id="user-school-feedback" placeholder="학교(학년)" />
                </div>
                <div class="action-icons">
                    <div class="icon-btn-container">
                        <button type="button" class="icon-btn" title="사진 촬영">📸
                            <input type="file" id="contentFile-camera-feedback" accept="image/*" capture="environment" />
                        </button>
                        <span class="icon-btn-label">사진 촬영</span>
                    </div>
                    <div class="icon-btn-container">
                        <button type="button" class="icon-btn" title="이미지 선택">🖼️
                            <input type="file" id="contentFile-gallery-feedback" accept="image/*" />
                        </button>
                        <span class="icon-btn-label">이미지 업로드</span>
                    </div>
                </div>
                <textarea id="contentText-feedback" class="input-area" placeholder="여기에 텍스트를 입력하세요."></textarea>
                <div class="file-info" id="file-info-feedback"><span class="file-name"></span></div>
                <div class="ocr-status" id="ocr-status-feedback">
                    <div class="spinner"></div><span>이미지에서 텍스트를 추출 중입니다...</span>
                </div>
                <button type="submit" id="submit-feedback-btn">피드백 받기 <span id="submit-spinner-feedback"
                        class="spinner"></span></button>
            </form>
            <div id="feedback-result"></div>
        </section>

        <section id="final-section" class="section">
            <form id="final-form">
                <label for="contentText-final">❇️최종 결과물을 위해 텍스트를 입력하거나 찍어서 업로드해 주세요.</label>
                <div class="user-info">
                    <input type="text" id="user-name-final" placeholder="이름" />
                    <input type="text" id="user-school-final" placeholder="학교" />
                </div>
                <div class="action-icons">
                    <div class="icon-btn-container">
                        <button type="button" class="icon-btn" title="사진 촬영">📸
                            <input type="file" id="contentFile-camera-final" accept="image/*" capture="environment" />
                        </button>
                        <span class="icon-btn-label">사진 촬영</span>
                    </div>
                    <div class="icon-btn-container">
                        <button type="button" class="icon-btn" title="이미지 선택">🖼️
                            <input type="file" id="contentFile-gallery-final" accept="image/*" />
                        </button>
                        <span class="icon-btn-label">이미지 업로드</span>
                    </div>
                </div>
                <textarea id="contentText-final" class="input-area" placeholder="여기에 텍스트를 입력하세요."></textarea>
                <div class="file-info" id="file-info-final"><span class="file-name"></span></div>
                <div class="ocr-status" id="ocr-status-final">
                    <div class="spinner"></div><span>이미지에서 텍스트를 추출 중입니다...</span>
                </div>
                <button type="submit" id="submit-final-btn">최종 결과 생성 <span id="submit-spinner-final"
                        class="spinner"></span></button>
            </form>
            <div id="final-result"></div>
        </section>
    </div>

    <script>
        const WORKER_URL = 'https://writing-feedback-app.sehyunglee2015.workers.dev';
        const PROXY_URL = WORKER_URL + '/proxy';
        window.feedbackFileURL = '';
        window.finalFileURL = '';
        
        // 이벤트 리스너 중복 방지를 위한 플래그
        let eventListenersAttached = false;

        // 페이지 멈춤 현상 방지를 위한 안전 장치
        function safeExecute(fn, fallback) {
            try {
                return fn();
            } catch (error) {
                console.error('함수 실행 오류:', error);
                if (fallback) fallback();
                return null;
            }
        }

        // 메모리 누수 방지를 위한 정리 함수
        function cleanupEventListeners() {
            const elements = ['reset-btn', 'tab-feedback', 'tab-final'];
            elements.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.onclick = null;
                }
            });
        }

        // Reset 기능
        function setupResetButton() {
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn && !resetBtn.onclick) {
                resetBtn.onclick = () => safeExecute(() => {
                    ['feedback', 'final'].forEach(sec => {
                        const textArea = document.getElementById(`contentText-${sec}`);
                        const fileInfo = document.getElementById(`file-info-${sec}`);
                        const ocrStatus = document.getElementById(`ocr-status-${sec}`);
                        const userName = document.getElementById(`user-name-${sec}`);
                        const userSchool = document.getElementById(`user-school-${sec}`);
                        const result = document.getElementById(`${sec}-result`) || document.getElementById(`${sec === 'feedback' ? 'feedback-result' : 'final-result'}`);
                        
                        if (textArea) textArea.value = '';
                        if (fileInfo) fileInfo.classList.remove('show');
                        if (ocrStatus) ocrStatus.classList.remove('show');
                        if (textArea) textArea.classList.remove('has-image');
                        if (userName) userName.value = '';
                        if (userSchool) userSchool.value = '';
                        if (result) result.innerHTML = '';
                    });
                    window.feedbackFileURL = '';
                    window.finalFileURL = '';
                });
            }
        }

        // 탭 전환 기능
        function setupTabSwitching() {
            const feedbackTab = document.getElementById('tab-feedback');
            const finalTab = document.getElementById('tab-final');
            
            if (feedbackTab && !feedbackTab.onclick) {
                feedbackTab.onclick = () => safeExecute(() => {
                    document.getElementById('feedback-section').classList.add('active');
                    feedbackTab.classList.add('active');
                    document.getElementById('final-section').classList.remove('active', 'final-theme');
                    finalTab.classList.remove('active');
                });
            }
            
            if (finalTab && !finalTab.onclick) {
                finalTab.onclick = () => safeExecute(() => {
                    document.getElementById('final-section').classList.add('active', 'final-theme');
                    finalTab.classList.add('active');
                    document.getElementById('feedback-section').classList.remove('active');
                    feedbackTab.classList.remove('active');
                });
            }
        }

        // EXIF 데이터 읽기 함수
        function getImageOrientation(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const view = new DataView(e.target.result);
                    if (view.getUint16(0, false) !== 0xFFD8) {
                        resolve(1);
                        return;
                    }
                    const length = view.byteLength;
                    let offset = 2;
                    while (offset < length) {
                        const marker = view.getUint16(offset, false);
                        offset += 2;
                        if (marker === 0xFFE1) {
                            const exifOffset = offset + 4;
                            if (view.getUint32(exifOffset, false) === 0x45786966) {
                                const tiffOffset = exifOffset + 6;
                                const firstIFDOffset = view.getUint32(tiffOffset + 4, true) + tiffOffset;
                                const entryCount = view.getUint16(firstIFDOffset, true);
                                for (let i = 0; i < entryCount; i++) {
                                    const entryOffset = firstIFDOffset + 2 + (i * 12);
                                    if (view.getUint16(entryOffset, true) === 0x0112) {
                                        resolve(view.getUint16(entryOffset + 8, true));
                                        return;
                                    }
                                }
                            }
                        }
                        offset += view.getUint16(offset, false);
                    }
                    resolve(1);
                };
                reader.readAsArrayBuffer(file.slice(0, 64 * 1024));
            });
        }

        // 이미지 회전 함수
        function rotateImageBasedOnOrientation(canvas, ctx, orientation) {
            const { width, height } = canvas;
            
            switch (orientation) {
                case 3: // 180도 회전
                    ctx.transform(-1, 0, 0, -1, width, height);
                    break;
                case 6: // 90도 시계방향 회전
                    canvas.width = height;
                    canvas.height = width;
                    ctx.transform(0, 1, -1, 0, height, 0);
                    break;
                case 8: // 90도 반시계방향 회전
                    canvas.width = height;
                    canvas.height = width;
                    ctx.transform(0, -1, 1, 0, 0, width);
                    break;
                default:
                    return false; // 회전 불필요
            }
            return true;
        }

        // 텍스트 정리 함수
        function cleanExtractedText(text) {
            if (!text || typeof text !== 'string') {
                return '';
            }
            
            // 1. 숫자 리스트 제거 (예: "1.", "2.", "3." 등)
            text = text.replace(/^\s*\d+\.\s*/gm, '');
            
            // 2. 연속된 공백을 하나로 정리
            text = text.replace(/[ \t]+/g, ' ');
            
            // 3. 3개 이상의 연속 줄바꿈을 2개로
            text = text.replace(/\n{3,}/g, '\n\n');
            
            // 4. 각 줄의 앞뒤 공백 제거
            text = text.split('\n').map(line => line.trim()).join('\n');
            
            // 5. 빈 줄이 너무 많은 경우 정리
            text = text.replace(/(\n\s*){3,}/g, '\n\n');
            
            // 6. 문장 끝의 불필요한 공백 정리
            text = text.replace(/\.\s{2,}/g, '. ');
            text = text.replace(/\?\s{2,}/g, '? ');
            text = text.replace(/!\s{2,}/g, '! ');
            
            return text.trim();
        }

        // 이미지 전처리 함수
        function preprocessImage(canvas, ctx) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const contrast = 1.2;
            const brightness = 10;
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, contrast * (data[i] - 128) + 128 + brightness));
                data[i + 1] = Math.min(255, Math.max(0, contrast * (data[i + 1] - 128) + 128 + brightness));
                data[i + 2] = Math.min(255, Math.max(0, contrast * (data[i + 2] - 128) + 128 + brightness));
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        // OCR 함수
        async function doOCR(file, section) {
            const status = document.getElementById(`ocr-status-${section}`);
            const textArea = document.getElementById(`contentText-${section}`);
            
            if (!status || !textArea) return;
            
            status.classList.add('show');
            
            try {
                if (file.size > 10 * 1024 * 1024) {
                    throw new Error('파일 크기가 너무 큽니다. 10MB 이하의 이미지를 사용해주세요.');
                }
                
                if (!file.type.startsWith('image/')) {
                    throw new Error('이미지 파일만 업로드 가능합니다.');
                }

                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                await new Promise((resolve) => {
                    img.onload = resolve;
                    img.src = URL.createObjectURL(file);
                });
                
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                // 이미지 전처리 적용
                preprocessImage(canvas, ctx);
                
                const processedDataUrl = canvas.toDataURL('image/jpeg', 0.95);
                const b64 = processedDataUrl.split(',')[1];
                
                const requestBody = {
                    model: 'gpt-4o-mini',
                    messages: [{
                        role: 'user',
                        content: [{
                            type: 'text',
                            text: `이 이미지에서 영어 텍스트를 정확히 추출해주세요. 다음 규칙을 따라주세요:
1. 이미지에 있는 모든 영어 텍스트를 순서대로 추출
2. 줄바꿈과 문단 구조 유지
3. 오타나 추측하지 말고 보이는 그대로 정확히 입력
4. 추가 설명이나 코멘트 없이 텍스트만 반환
5. 불명확한 글자는 가장 유사한 영어 단어로 추정
6. 숫자 리스트나 불필요한 기호는 제외`
                        }, {
                            type: 'image_url',
                            image_url: { url: processedDataUrl }
                        }]
                    }],
                    max_tokens: 1500,
                    temperature: 0.1
                };
                
                const resp = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!resp.ok) {
                    throw new Error(`API 오류: ${resp.status}`);
                }
                
                const data = await resp.json();
                const extractedText = data.choices?.[0]?.message?.content?.trim() || '';
                
                if (extractedText) {
                    const cleanedText = cleanExtractedText(extractedText);
                    textArea.value = cleanedText;
                } else {
                    textArea.value = '텍스트를 인식할 수 없습니다. 이미지가 선명한지 확인하고 다시 시도해주세요.';
                }
                
            } catch (error) {
                console.error('OCR 오류:', error);
                let userMessage = '이미지 처리 중 오류가 발생했습니다.';
                
                if (error.message.includes('네트워크')) {
                    userMessage = '네트워크 연결을 확인하고 다시 시도해주세요.';
                } else if (error.message.includes('파일')) {
                    userMessage = error.message;
                } else if (error.message.includes('API')) {
                    userMessage = error.message;
                } else {
                    userMessage = '텍스트 추출에 실패했습니다. 다른 이미지를 시도해보거나 직접 텍스트를 입력해주세요.';
                }
                
                textArea.value = userMessage;
                
                setTimeout(() => {
                    alert(userMessage + '\n\n직접 텍스트를 입력하거나 다른 이미지를 시도해보세요.');
                }, 100);
                
            } finally {
                status.classList.remove('show');
            }
        }

        // 파일 업로드 이벤트 설정
        function setupFileUpload() {
            ['feedback', 'final'].forEach(section => {
                ['camera', 'gallery'].forEach(src => {
                    const fileInput = document.getElementById(`contentFile-${src}-${section}`);
                    if (fileInput && !fileInput.onchange) {
                        fileInput.onchange = (e) => safeExecute(async () => {
                            const file = e.target.files[0];
                            if (!file) return;
                            
                            const url = URL.createObjectURL(file);
                            window[`${section}FileURL`] = url;
                            const info = document.getElementById(`file-info-${section}`);
                            if (info) {
                                info.querySelector('.file-name').textContent = file.name;
                                info.classList.add('show');
                            }
                            const textArea = document.getElementById(`contentText-${section}`);
                            if (textArea) textArea.classList.add('has-image');
                            
                            await doOCR(file, section);
                        });
                    }
                });
            });
        }

        // 피드백 텍스트 처리 함수
        function processFeedback(feedback, originalText) {
            const originalLines = originalText.trim().split(/\n+/);
            
            const overviewPattern = /(?:총평|전체\s*평가|종합\s*평가)[\s]*:[\s\S]*?(?=(?:문법\s*오류|어휘\s*개선|표현\s*향상|잘한\s*점)\s*:|$)/i;
            const grammarPattern = /문법\s*오류\s*:[\s\S]*?(?=(?:총평|전체\s*평가|종합\s*평가|어휘\s*개선|표현\s*향상|잘한\s*점)\s*:|$)/i;
            const vocabPattern = /어휘\s*개선\s*:[\s\S]*?(?=(?:총평|전체\s*평가|종합\s*평가|문법\s*오류|표현\s*향상|잘한\s*점)\s*:|$)/i;
            const expressionPattern = /표현\s*향상\s*:[\s\S]*?(?=(?:총평|전체\s*평가|종합\s*평가|문법\s*오류|어휘\s*개선|잘한\s*점)\s*:|$)/i;
            const strengthsPattern = /잘한\s*점\s*:[\s\S]*?(?=(?:총평|전체\s*평가|종합\s*평가|문법\s*오류|어휘\s*개선|표현\s*향상)\s*:|$)/i;
            
            let html = '<div class="feedback-container">';
            
            // 총평 섹션
            const overview = feedback.match(overviewPattern);
            if (overview && overview[0].trim().length > 0) {
                const overviewContent = overview[0].replace(/(?:총평|전체\s*평가|종합\s*평가)\s*:/i, '').trim();
                if (overviewContent) {
                    // 불필요한 숫자 제거
                    const cleanedOverview = cleanExtractedText(overviewContent);
                    html += `
                        <div class="overview-category">
                            <h3><i class="fas fa-star"></i> 총평</h3>
                            <div class="content">${cleanedOverview.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }
            }
            
            // 각 카테고리별 처리
            const categories = [
                { name: '문법 오류', pattern: grammarPattern, class: 'grammar', icon: 'fas fa-exclamation-circle' },
                { name: '어휘 개선', pattern: vocabPattern, class: 'vocabulary', icon: 'fas fa-book' },
                { name: '표현 향상', pattern: expressionPattern, class: 'expression', icon: 'fas fa-pencil-alt' },
                { name: '잘한 점', pattern: strengthsPattern, class: 'strengths', icon: 'fas fa-thumbs-up' }
            ];
            
            categories.forEach(category => {
                const match = feedback.match(category.pattern);
                if (match && match[0].trim().length > 0) {
                    const content = match[0].replace(new RegExp(`${category.name.replace('점', '\\s*점')}\\s*:`, 'i'), '').trim();
                    if (content) {
                        const cleanedContent = cleanExtractedText(content);
                        const points = extractFeedbackPoints(cleanedContent, originalLines);
                        
                        html += `
                            <div class="feedback-category ${category.class}">
                                <h3><i class="${category.icon}"></i> ${category.name}</h3>
                                ${points}
                            </div>
                        `;
                    }
                }
            });
            
            html += '</div>';
            return html;
        }

        // 피드백 포인트 추출 함수
        function extractFeedbackPoints(content, originalLines) {
            const points = content.split(/\n\s*\n+/).filter(p => p.trim());
            let html = '';
            
            points.forEach(point => {
                const cleanPoint = cleanExtractedText(point);
                const englishQuotes = cleanPoint.match(/["']([^"']+)["']|`([^`]+)`|\b([A-Za-z][\w\s,.!?;:'"()-]*?[.!?])\b/g);
                
                let originalTextFound = '';
                
                if (englishQuotes && englishQuotes.length > 0) {
                    const cleanQuotes = englishQuotes.map(q => q.replace(/^["'`]|["'`]$/g, '').trim());
                    
                    for (const line of originalLines) {
                        for (const quote of cleanQuotes) {
                            if (quote.length > 3 && line.includes(quote)) {
                                originalTextFound = line.trim();
                                break;
                            }
                        }
                        if (originalTextFound) break;
                    }
                }
                
                html += `
                    ${originalTextFound ? `<div class="original-text">${originalTextFound}</div>` : ''}
                    <div class="feedback-point">${cleanPoint.replace(/\n/g, '<br>')}</div>
                    <hr style="border: 0; height: 1px; background-color: #e2e8f0; margin: 10px 0;">
                `;
            });
            
            html = html.replace(/<hr[^>]*>$/i, '');
            return html;
        }

        // Edit/Save 버튼 토글 기능
        function setupEditSaveToggle(contentId, containerId) {
            const content = document.getElementById(contentId);
            const container = document.getElementById(containerId);
            
            if (!content || !container) return;
            
            content.setAttribute('contenteditable', 'false');
            
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.className = 'edit-save-btn';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'btn-group';
            wrapper.appendChild(editBtn);
            container.appendChild(wrapper);
            
            editBtn.onclick = () => safeExecute(() => {
                const isEditing = content.getAttribute('contenteditable') === 'true';
                
                if (isEditing) {
                    content.setAttribute('contenteditable', 'false');
                    editBtn.textContent = 'Edit';
                    editBtn.style.backgroundColor = '#64748b';
                    content.style.border = 'none';
                    content.style.backgroundColor = 'transparent';
                } else {
                    content.setAttribute('contenteditable', 'true');
                    editBtn.textContent = 'Save';
                    editBtn.style.backgroundColor = '#16a34a';
                    content.style.border = '2px dashed #16a34a';
                    content.style.backgroundColor = '#f0fdf4';
                    content.focus();
                }
            });
        }

        // 수정글 텍스트 포맷팅
        function formatCorrectedText(text) {
            let formatted = text.replace(/\n/g, '<br>');
            formatted = formatted.replace(/\(([^)]+)\)/g, '(<span class="highlight">$1</span>)');
            formatted = formatted.replace(/\*([^*]+)\*/g, '<span class="highlight">$1</span>');
            return formatted;
        }

        // PDF 파일명 생성
        function generatePDFFileName(userName) {
            const today = new Date();
            const dateStr = today.getFullYear() + 
                           String(today.getMonth() + 1).padStart(2, '0') + 
                           String(today.getDate()).padStart(2, '0');
            
            if (userName && userName.trim()) {
                return `${userName.trim()}_리얼스피치_${dateStr}`;
            } else {
                return `WriteBack_${dateStr}`;
            }
        }

        // 인쇄용 이미지 회전 함수
        function getRotatedImageForPrint(imageUrl, callback) {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const isLandscape = img.width > img.height;
                
                if (isLandscape) {
                    canvas.width = img.height;
                    canvas.height = img.width;
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(90 * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                }
                
                const rotatedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                callback(rotatedDataUrl);
            };
            img.src = imageUrl;
        }

        // 인쇄 HTML 생성 함수
        function generateAndPrintHTML(imageUrl, orig, fbCheck, corr, name, school, type) {
            const fileName = generatePDFFileName(name);
            
            let html = `<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>${fileName}</title>
    <style>
        @page {
            margin: 15mm;
            size: A4;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: white;
            color: black;
            line-height: 1.4;
        }
        
        .print-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            border-bottom: 3px solid #1e3a8a;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .print-header .logo {
            height: 60px;
            margin-bottom: 10px;
        }
        
        .print-header .title {
            font-size: 28px;
            font-weight: bold;
            color: #1e3a8a;
            margin: 0;
            text-align: center;
            letter-spacing: 1px;
        }
        
        .content-section {
            margin-bottom: 8px;
        }
        
        .content-section h2 {
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 18px;
            color: #1e3a8a;
        }
        
        .content-section p, .content-section div {
            margin-bottom: 6px;
            margin-top: 0;
        }
        
        .feedback-category, .overview-category, .corrected-section {
            margin-bottom: 8px;
            padding: 8px 12px;
            page-break-inside: avoid;
            border-left-width: 5px;
            border-left-style: solid;
        }
        
        .overview-category {
            border-left-color: #8b5cf6;
            background-color: #f5f3ff;
        }
        
        .grammar { border-left-color: #e74c3c; background-color: #fdeded; }
        .vocabulary { border-left-color: #3498db; background-color: #ebf5fb; }
        .expression { border-left-color: #9b59b6; background-color: #f4ecf7; }
        .strengths { border-left-color: #2ecc71; background-color: #ebfaf0; }
        .corrected-section { border-left-color: #10b981; background-color: #ecfdf5; }
        
        .original-text {
            margin: 4px 0;
            padding: 6px 10px;
            background-color: rgba(248, 250, 252, 0.8);
            border-left: 3px solid #94a3b8;
            font-style: italic;
            color: #475569;
        }
        
        .original-text::before {
            content: '원문';
            display: block;
            font-weight: 600;
            font-style: normal;
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: #64748b;
        }
        
        .feedback-point {
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        hr {
            margin: 3px 0;
            border: 0;
            height: 1px;
            background-color: #e2e8f0;
        }
        
        img {
            max-width: 100%;
            height: auto;
            page-break-inside: avoid;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        h3 {
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="print-header">
        <img src="https://page1.genspark.site/v1/base64_upload/78cc0523b080d22fe6d247fc2d9bf3c4" alt="윤선생 로고" class="logo">
        <h1 class="title">윤선생 리얼스피치 2025</h1>
    </div>
    
    <div class="print-content">`;
    
            // 사용자 정보가 있을 때만 표시
            if (name?.trim() || school?.trim()) {
                html += `<div class="content-section user-info" style="margin-bottom: 15px; padding: 8px; background-color: #f8fafc; border-radius: 4px;">`;
                if (name?.trim()) html += `<strong>이름:</strong> ${name.trim()}`;
                if (name?.trim() && school?.trim()) html += ` &nbsp;&nbsp; `;
                if (school?.trim()) html += `<strong>학교:</strong> ${school.trim()}`;
                html += `</div>`;
            }
            
            // 원본 내용
            if (orig) {
                html += '<div class="content-section"><h2>원본</h2>';
                if (imageUrl) {
                    html += `<div style="margin: 10px 0;"><img src="${imageUrl}" alt="원본 이미지" /></div>`;
                } else {
                    const textContent = type === 'feedback' ? 
                        document.getElementById('contentText-feedback')?.value || '' : 
                        document.getElementById('contentText-final')?.value || '';
                    html += `<div style="white-space: pre-wrap; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8fafc;">${textContent}</div>`;
                }
                html += '</div>';
            }
            
            // 피드백 내용
            if (fbCheck && type === 'feedback') {
                const feedbackContent = document.getElementById('fb-content');
                if (feedbackContent) {
                    html += '<div class="content-section"><h2>피드백</h2>' + feedbackContent.outerHTML + '</div>';
                }
            }
            
            // 수정글 내용
            if (corr) {
                const correctedElement = type === 'feedback' ? 
                    document.getElementById('fb-corrected') : 
                    document.getElementById('fn-corrected');
                
                if (correctedElement) {
                    html += '<div class="content-section"><h2>수정글</h2>';
                    html += `<div class="corrected-section">`;
                    html += `<div style="background-color: #ffffff; padding: 12px; border-radius: 6px; line-height: 1.6; border: 1px solid #d1fae5;">${correctedElement.innerHTML}</div>`;
                    html += '</div></div>';
                }
            }
            
            html += `
    </div>
    <script>
        document.title = "${fileName}";
        window.onload = function() {
            setTimeout(() => {
                window.print();
                window.onafterprint = function() {
                    window.close();
                };
            }, 1000);
        };
    </script>
</body>
</html>`;
            
            try {
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (!printWindow) {
                    alert('팝업이 차단되었습니다. 브라우저 설정에서 팝업을 허용해주세요.');
                    return;
                }
                
                printWindow.document.open();
                printWindow.document.write(html);
                printWindow.document.close();
            } catch (error) {
                console.error('인쇄 오류:', error);
                alert('인쇄 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        // 피드백 폼 제출
        function setupFeedbackForm() {
            const form = document.getElementById('feedback-form');
            if (form && !form.onsubmit) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    return safeExecute(async () => {
                        const contentText = document.getElementById('contentText-feedback').value.trim();
                        if (!contentText) {
                            alert("영작한 내용을 입력하거나 이미지 업로드 후 실행해주세요!");
                            return;
                        }
                        
                        const btn = document.getElementById('submit-feedback-btn');
                        const sp = document.getElementById('submit-spinner-feedback');
                        
                        if (btn) btn.disabled = true;
                        if (sp) sp.style.display = 'inline-block';
                        
                        try {
                            const res = await fetch(`${WORKER_URL}/api/feedback`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contentText })
                            });
                            
                            const { feedback, modelAnswer } = await res.json();
                            const container = document.getElementById('feedback-result');
                            
                            const formattedFeedback = processFeedback(feedback, contentText);
                            
                            if (container) {
                                container.innerHTML = `
                                    <p style="text-align: left;">
                                        📢 AI는 실수를 할 수 있습니다. 꼭 생성된 내용을 확인 후 필요한 부분은 수정하셔서 이용해주세요~!
                                    </p>
                                    <div class="box" id="fb-box">
                                        <h2>피드백</h2>
                                        <div class="edit-instruction">
                                            💡 내용에서 원하는 부분을 수정하려면 Edit 버튼을 누른 후 입력하시고 Save를 눌러 저장해주세요.
                                        </div>
                                        <div id="fb-content">${formattedFeedback}</div>
                                    </div>
                                    <div class="corrected-section" id="fb-corr-box">
                                        <h3><i class="fas fa-check-circle"></i> 수정글</h3>
                                        <div class="edit-instruction">
                                            💡 내용에서 원하는 부분을 수정하려면 Edit 버튼을 누른 후 입력하시고 Save를 눌러 저장해주세요.
                                        </div>
                                        <div class="corrected-content" id="fb-corrected">${formatCorrectedText(modelAnswer)}</div>
                                    </div>
                                    <button id="print-feedback-btn">인쇄</button>
                                    <div class="print-options-inline" id="print-options-feedback" style="display:none;">
                                        <label><input type="checkbox" id="print_orig_fb" checked> 원본</label>
                                        <label><input type="checkbox" id="print_fb_fb" checked> 피드백</label>
                                        <label><input type="checkbox" id="print_corr_fb" checked> 수정글</label>
                                        <button id="confirm-print-feedback-btn">Confirm</button>
                                    </div>
                                `;
                                
                                // Edit/Save 버튼 설정
                                setTimeout(() => {
                                    setupEditSaveToggle('fb-content', 'fb-box');
                                    setupEditSaveToggle('fb-corrected', 'fb-corr-box');
                                    
                                    // 인쇄 버튼 이벤트
                                    const printBtn = document.getElementById('print-feedback-btn');
                                    const confirmBtn = document.getElementById('confirm-print-feedback-btn');
                                    
                                    if (printBtn) {
                                        printBtn.onclick = () => {
                                            const options = document.getElementById('print-options-feedback');
                                            if (options) options.style.display = 'flex';
                                        };
                                    }
                                    
                                    if (confirmBtn) {
                                        confirmBtn.onclick = () => safeExecute(() => {
                                            const orig = document.getElementById('print_orig_fb')?.checked;
                                            const fbCheck = document.getElementById('print_fb_fb')?.checked;
                                            const corr = document.getElementById('print_corr_fb')?.checked;
                                            const name = document.getElementById('user-name-feedback')?.value;
                                            const school = document.getElementById('user-school-feedback')?.value;
                                            
                                            const options = document.getElementById('print-options-feedback');
                                            if (options) options.style.display = 'none';
                                            
                                            if (orig && window.feedbackFileURL && window.feedbackFileURL.startsWith('blob:')) {
                                                getRotatedImageForPrint(window.feedbackFileURL, (rotatedImageUrl) => {
                                                    generateAndPrintHTML(rotatedImageUrl, orig, fbCheck, corr, name, school, 'feedback');
                                                });
                                            } else {
                                                generateAndPrintHTML(window.feedbackFileURL, orig, fbCheck, corr, name, school, 'feedback');
                                            }
                                        });
                                    }
                                }, 100);
                            }
                        } catch (e) {
                            alert('피드백 요청 중 오류가 발생했습니다.');
                        } finally {
                            if (btn) btn.disabled = false;
                            if (sp) sp.style.display = 'none';
                        }
                    });
                };
            }
        }

        // 최종 결과 폼 제출
        function setupFinalForm() {
            const form = document.getElementById('final-form');
            if (form && !form.onsubmit) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    return safeExecute(async () => {
                        const contentText = document.getElementById('contentText-final').value.trim();
                        if (!contentText) {
                            alert("영작한 내용을 입력하거나 이미지 업로드 후 실행해주세요!");
                            return;
                        }
                        
                        const btn = document.getElementById('submit-final-btn');
                        const sp = document.getElementById('submit-spinner-final');
                        
                        if (btn) btn.disabled = true;
                        if (sp) sp.style.display = 'inline-block';
                        
                        try {
                            const res = await fetch(`${WORKER_URL}/api/feedback`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contentText })
                            });
                            
                            const { feedback, modelAnswer } = await res.json();
                            const cont = document.getElementById('final-result');
                            
                            if (cont) {
                                cont.innerHTML = `
                                    <p style="text-align: left;">
                                        📢 AI는 실수를 할 수 있습니다. 꼭 생성된 내용을 확인 후 필요한 부분은 수정하셔서 이용해주세요~!
                                    </p>
                                    <div class="corrected-section" id="fn-box">
                                        <h3><i class="fas fa-check-circle"></i> 수정글</h3>
                                        <div class="edit-instruction">
                                            💡 내용에서 원하는 부분을 수정하려면 Edit 버튼을 누른 후 입력하시고 Save를 눌러 저장해주세요.
                                        </div>
                                        <div class="corrected-content" id="fn-corrected">${formatCorrectedText(modelAnswer)}</div>
                                    </div>
                                    <div class="btn-group" id="fn-edit-group"></div>
                                    <div class="audio-controls-area">
                                        <button id="tts-play-btn">원어민 음성 듣기</button><span id="tts-spinner" class="spinner"></span>
                                        <audio id="tts-audio-final" controls style="display:none;"></audio>
                                        <a id="tts-download-btn" style="display:none;">음원 다운로드</a>
                                    </div>
                                    <div class="print-button-bottom">
                                        <a id="print-final-btn" class="button">인쇄</a>
                                    </div>
                                    <div class="print-options-inline" id="print-options-final" style="display:none;">
                                        <label><input type="checkbox" id="print_orig_fn" checked> 원본</label>
                                        <label><input type="checkbox" id="print_corr_fn" checked> 수정글</label>
                                        <button id="confirm-print-final-btn">Confirm</button>
                                    </div>
                                `;
                                
                                // Edit/Save 버튼 설정
                                setTimeout(() => {
                                    setupEditSaveToggle('fn-corrected', 'fn-box');
                                    
                                    // TTS 기능
                                    const playBtn = document.getElementById('tts-play-btn');
                                    const spinner = document.getElementById('tts-spinner');
                                    const dl = document.getElementById('tts-download-btn');
                                    const audio = document.getElementById('tts-audio-final');
                                    
                                    if (playBtn) {
                                        playBtn.onclick = async () => safeExecute(async () => {
                                            playBtn.disabled = true;
                                            if (spinner) spinner.style.display = 'inline-block';
                                            
                                            try {
                                                const textFinal = document.getElementById('fn-corrected')?.innerText || '';
                                                const r = await fetch(`${WORKER_URL}/api/tts`, {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ text: textFinal })
                                                });
                                                const blob = await r.blob();
                                                const url = URL.createObjectURL(blob);
                                                
                                                if (audio) {
                                                    audio.src = url;
                                                    audio.style.display = 'block';
                                                }
                                                
                                                if (dl) {
                                                    dl.style.display = 'inline-block';
                                                    const userName = document.getElementById('user-name-final')?.value.trim() || 'writing';
                                                    dl.href = url;
                                                    dl.download = `${userName}.mp3`;
                                                }
                                            } catch (e) {
                                                alert('TTS 에러: ' + e.message);
                                            } finally {
                                                playBtn.disabled = false;
                                                if (spinner) spinner.style.display = 'none';
                                            }
                                        });
                                    }
                                    
                                    // 인쇄 기능
                                    const printBtn = document.getElementById('print-final-btn');
                                    const confirmBtn = document.getElementById('confirm-print-final-btn');
                                    
                                    if (printBtn) {
                                        printBtn.onclick = () => {
                                            const options = document.getElementById('print-options-final');
                                            if (options) options.style.display = 'flex';
                                        };
                                    }
                                    
                                    if (confirmBtn) {
                                        confirmBtn.onclick = () => safeExecute(() => {
                                            const orig = document.getElementById('print_orig_fn')?.checked;
                                            const corr = document.getElementById('print_corr_fn')?.checked;
                                            const name = document.getElementById('user-name-final')?.value;
                                            const school = document.getElementById('user-school-final')?.value;
                                            
                                            const options = document.getElementById('print-options-final');
                                            if (options) options.style.display = 'none';
                                            
                                            if (orig && window.finalFileURL && window.finalFileURL.startsWith('blob:')) {
                                                getRotatedImageForPrint(window.finalFileURL, (rotatedImageUrl) => {
                                                    generateAndPrintHTML(rotatedImageUrl, orig, false, corr, name, school, 'final');
                                                });
                                            } else {
                                                generateAndPrintHTML(window.finalFileURL, orig, false, corr, name, school, 'final');
                                            }
                                        });
                                    }
                                }, 100);
                            }
                        } catch (e) {
                            alert('최종 결과물 요청 중 오류가 발생했습니다.');
                        } finally {
                            if (btn) btn.disabled = false;
                            if (sp) sp.style.display = 'none';
                        }
                    });
                };
            }
        }

        // 초기화 함수
        function initialize() {
            if (eventListenersAttached) return;
            
            safeExecute(() => {
                setupResetButton();
                setupTabSwitching();
                setupFileUpload();
                setupFeedbackForm();
                setupFinalForm();
                
                eventListenersAttached = true;
            });
        }

        // 페이지 로드 시 초기화
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        // 페이지 재활성화 시 안전 장치
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(() => {
                    if (!eventListenersAttached) {
                        initialize();
                    }
                }, 100);
            }
        });

        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', () => {
            cleanupEventListeners();
        });
    </script>
</body>

</html>
