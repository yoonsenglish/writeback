<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WriteBack</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ë ˆì´ì•„ì›ƒ --- */
        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            line-height: 1.6;
            color: #334155;
        }

        #container {
            width: 100%;
            max-width: 768px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            position: relative;
            border: 1px solid #e2e8f0;
        }

        /* Reset ë²„íŠ¼ ìš°ì¸¡ ì •ë ¬ ìŠ¤íƒ€ì¼ */
        .header-section {
            position: relative;
            text-align: center;
            margin-bottom: 2rem;
        }

        .header-section h1 {
            margin-bottom: 0.5rem;
            color: #1e3a8a;
            font-size: 2.25rem;
            font-weight: 700;
        }

        #reset-btn {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #ef4444;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #reset-btn:hover {
            background-color: #dc2626;
        }

        /* --- íƒ­ ê°œë³„ ìŠ¤íƒ€ì¼ --- */
        nav {
            text-align: center;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }

        /* ê³µí†µ íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-base {
            border: 2px solid transparent;
            padding: 0.8rem 1.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        /* í”¼ë“œë°± ë°›ê¸° íƒ­ (íŒŒë€ìƒ‰) */
        .tab-feedback {
            background-color: #e0e7ff;
            color: #3b82f6;
        }

        .tab-feedback.active {
            background-color: #1e40af;
            color: #ffffff;
            border: 3px solid #1e3a8a;
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.25);
            transform: translateY(-2px);
            font-weight: 700;
        }

        .tab-feedback:hover:not(.active) {
            background-color: #bfdbfe;
            color: #1e40af;
            border-color: #93c5fd;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.15);
        }

        .tab-feedback.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 4px;
            background-color: #ffffff;
            border-radius: 2px 2px 0 0;
        }

        /* ìµœì¢… ê²°ê³¼ë¬¼ ìƒì„± íƒ­ (ë…¹ìƒ‰) */
        .tab-final {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .tab-final.active {
            background-color: #16a34a;
            color: #ffffff;
            border: 3px solid #15803d;
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.25);
            transform: translateY(-2px);
            font-weight: 700;
        }

        .tab-final:hover:not(.active) {
            background-color: #bbf7d0;
            color: #15803d;
            border-color: #86efac;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.15);
        }

        .tab-final.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 4px;
            background-color: #ffffff;
            border-radius: 2px 2px 0 0;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ìµœì¢… ê²°ê³¼ë¬¼ í˜ì´ì§€ ë…¹ìƒ‰ í…Œë§ˆ --- */
        #final-section.final-theme .input-area {
            background-color: #f0fdf4;
            border-color: #bbf7d0;
        }

        #final-section.final-theme .input-area:focus {
            border-color: #16a34a;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }

        #final-section.final-theme button:not(.icon-btn):not(#reset-btn) {
            background-color: #16a34a;
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.2);
        }

        #final-section.final-theme button:not(.icon-btn):not(#reset-btn):hover {
            background-color: #15803d;
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.3);
        }

        #final-section.final-theme .user-info input {
            border-color: #bbf7d0;
            background-color: #f0fdf4;
        }

        #final-section.final-theme .user-info input:focus {
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }

        /* --- ì‚¬ìš©ì ì •ë³´ ì…ë ¥ --- */
        .user-info {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }

        .user-info input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            color: #475569;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .user-info input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* --- ì…ë ¥ ì˜ì—­ --- */
        .input-area {
            width: 100%;
            min-height: 180px;
            padding: 1.25rem;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            background-color: #f8fafc;
            resize: vertical;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1.05rem;
            line-height: 1.7;
            color: #334155;
        }

        .input-area:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

        .input-area.has-image {
            background-color: #eff6ff;
            border-color: #2563eb;
        }

        /* --- ì•„ì´ì½˜ ë²„íŠ¼ --- */
        .action-icons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .icon-btn-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 10px;
            background-color: #ffffff;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 1.5rem;
            color: #64748b;
        }

        .icon-btn:hover {
            background-color: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .icon-btn input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .icon-btn-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }

        /* --- íŒŒì¼ ì •ë³´ & OCR ìƒíƒœ --- */
        .file-info,
        .ocr-status {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-info {
            background-color: #e0f2fe;
            border: 1px solid #93c5fd;
            color: #1d4ed8;
            display: none;
        }

        .file-info.show {
            display: flex;
        }

        .file-info .file-name {
            flex: 1;
            font-weight: 500;
        }

        .ocr-status {
            background-color: #fefce8;
            border: 1px solid #fde68a;
            color: #b45309;
            display: none;
        }

        .ocr-status.show {
            display: flex;
        }

        .ocr-status .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #b45309;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- ì¼ë°˜ ë²„íŠ¼ --- */
        button:not(.icon-btn):not(#reset-btn):not(.tab-feedback):not(.tab-final),
        a.button {
            background-color: #3b82f6;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 0.85rem 1.8rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-top: 1.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        button:hover:not(.icon-btn):not(#reset-btn):not(.tab-feedback):not(.tab-final),
        a.button:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.3);
        }
        
        button:disabled, a.button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- ë²„íŠ¼ ê·¸ë£¹ --- */
        .btn-group {
            text-align: right;
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .btn-group button {
            margin-top: 0;
            background-color: #64748b;
            box-shadow: none;
        }

        .btn-group button:hover {
            background-color: #475569;
            transform: translateY(-2px);
        }

        .edit-save-btn {
            background-color: #64748b !important;
        }

        .edit-save-btn:hover {
            background-color: #475569 !important;
        }

        /* --- ìŠ¤í”¼ë„ˆ (TTS) --- */
        .spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 3px solid #ffffff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 0.8rem;
        }

        #tts-spinner {
            border-color: #3b82f6;
            border-top-color: transparent;
        }

        /* --- ê²°ê³¼ ë°•ìŠ¤ --- */
        .box,
        .model-box {
            background-color: #f1f5f9;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid #e2e8f0;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .box h2,
        .model-box h2 {
            margin: 0 0 1rem;
            color: #1e3a8a;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .model-box {
            background-color: #ffffff;
            font-size: 1.1rem;
            line-height: 1.8;
            border: 1px solid #d1d5db;
        }

        /* --- Edit ì•ˆë‚´ ë¬¸êµ¬ --- */
        .edit-instruction {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #1e40af;
            text-align: center;
        }

        /* --- í”¼ë“œë°± ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ --- */
        .feedback-container {
            margin-top: 1rem;
        }

        .feedback-category {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
        }

        .feedback-category:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .feedback-category h3 {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            margin-top: 0;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .feedback-category h3 i {
            margin-right: 8px;
            font-size: 1.4rem;
        }

        /* ì´í‰ ìŠ¤íƒ€ì¼ ê°œì„  */
        .overview-category {
            background-color: #f5f3ff;
            border-left: 5px solid #8b5cf6;
            padding: 15px 20px; /* ì¢Œì¸¡ íŒ¨ë”© ì¦ê°€ */
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .overview-category h3 {
            display: flex;
            align-items: center;
            color: #5b21b6;
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .overview-category h3 i {
            margin-right: 10px;
        }

        .overview-category .content {
            margin-left: 10px; /* ë‚´ìš© ì¢Œì¸¡ ì—¬ë°± ì¶”ê°€ */
            line-height: 1.6;
        }

        /* í”¼ë“œë°± ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ */
        .grammar {
            background-color: #fdeded;
            border-left: 5px solid #e74c3c;
        }

        .vocabulary {
            background-color: #ebf5fb;
            border-left: 5px solid #3498db;
        }

        .expression {
            background-color: #f4ecf7;
            border-left: 5px solid #9b59b6;
        }

        .strengths {
            background-color: #ebfaf0;
            border-left: 5px solid #2ecc71;
        }

        /* ì›ë¬¸ ì¸ìš© ìŠ¤íƒ€ì¼ */
        .original-text {
            background-color: rgba(255, 255, 255, 0.7);
            border-left: 3px solid #94a3b8;
            padding: 10px 15px;
            margin: 10px 0;
            font-style: italic;
            color: #475569;
            border-radius: 4px;
        }

        .original-text::before {
            content: 'ì›ë¬¸';
            display: block;
            font-weight: 600;
            font-style: normal;
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: #64748b;
        }

        .feedback-point {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        /* ìˆ˜ì •ê¸€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .corrected-section {
            background-color: #ecfdf5;
            border-left: 5px solid #10b981;
            padding: 15px 20px;
            margin-top: 30px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .corrected-section h3 {
            display: flex;
            align-items: center;
            color: #047857;
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .corrected-section h3 i {
            margin-right: 10px;
        }

        .corrected-content {
            background-color: #ffffff;
            padding: 18px;
            border-radius: 6px;
            line-height: 1.8;
            font-size: 1.05rem;
            color: #1f2937;
            border: 1px solid #d1fae5;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
        }

        /* --- ì¸ë¼ì¸ Print ì˜µì…˜ --- */
        .print-options-inline {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .print-options-inline label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
        }

        .print-options-inline input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }
        
        .print-options-inline button {
            margin-top: 0;
            margin-left: auto;
            background-color: #10b981;
        }

        .print-options-inline button:hover {
            background-color: #059669;
        }

        /* --- ìµœì¢… ì‚°ì¶œë¬¼ ì½”ë„ˆ íŠ¹ì • ìŠ¤íƒ€ì¼ --- */
        #final-section .button-area {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 1.5rem;
        }

        #final-section .audio-controls-area {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
            width: 100%;
        }

        #final-section #tts-play-btn {
            width: fit-content;
            margin-top: 0;
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
            background-color: #6366f1;
        }

        #final-section #tts-play-btn:hover {
            background-color: #4f46e5;
        }

        #final-section #tts-audio-final {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #a78bfa;
            background-color: #f5f3ff;
            outline: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        #final-section #tts-download-btn {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 0;
            display: inline-block;
            transition: color 0.2s ease-in-out;
            margin-top: -0.5rem;
        }

        #final-section #tts-download-btn:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        #final-section .print-button-bottom {
            margin-top: 2.5rem;
            text-align: left;
            width: 100%;
        }
        
        #final-section .print-button-bottom .button {
            width: fit-content;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            #container {
                padding: 1.5rem;
                margin: 0;
                max-width: 100%;
                box-shadow: none;
                border-radius: 8px;
            }
            
            .header-section h1 {
                font-size: 1.6rem;
                margin-bottom: 0.3rem;
                line-height: 1.3;
                padding-right: 100px;
            }
            
            #reset-btn {
                position: absolute;
                top: 0;
                right: 0;
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }
            
            .user-info {
                flex-direction: column;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .user-info input {
                width: 100%;
                padding: 0.8rem;
                font-size: 1rem;
                border-radius: 6px;
            }
            
            nav {
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1.5rem;
            }
            
            .tab-base {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
                width: 100%;
                text-align: center;
            }
            
            .input-area {
                min-height: 150px;
                padding: 1rem;
                font-size: 1rem;
            }
            
            .action-icons {
                justify-content: center;
                gap: 1rem;
                flex-wrap: wrap;
            }
            
            .icon-btn-container {
                gap: 0.3rem;
            }
            
            .icon-btn {
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
            }
            
            .icon-btn-label {
                font-size: 0.8rem;
            }
            
            button:not(.icon-btn):not(#reset-btn):not(.tab-feedback):not(.tab-final),
            a.button {
                padding: 0.9rem 1.5rem;
                font-size: 1rem;
                width: 100%;
                margin-top: 1rem;
            }
            
            .feedback-category,
            .overview-category {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .feedback-category h3,
            .overview-category h3 {
                font-size: 1.1rem;
            }
            
            .print-options-inline {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .print-options-inline button {
                width: 100%;
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
            }
            
            #container {
                padding: 1rem;
            }
            
            .header-section h1 {
                font-size: 1.4rem;
                padding-right: 90px;
            }
            
            #reset-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .tab-base {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .input-area {
                min-height: 120px;
                padding: 0.75rem;
            }
        }

        /* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
        @media print {
            nav, button, a.button, #reset-btn, .action-icons, .btn-group,
            .print-options-inline, #tts-audio-final + #tts-download-btn {
                display: none !important;
            }
            body {
                background-color: #ffffff;
                margin: 0;
                padding: 1rem;
                color: #000000;
                font-family: serif;
            }
            #container {
                box-shadow: none;
                border: none;
                padding: 0;
                max-width: 100%;
            }
            h1, h2 {
                color: #000000 !important;
                text-align: left;
            }
            .box, .model-box {
                background-color: #ffffff;
                border: 1px solid #cccccc;
                padding: 1rem;
                margin-top: 1rem;
                box-shadow: none;
            }
            .user-info {
                display: block;
                margin-bottom: 1rem;
            }
            .user-info input {
                border: none;
                padding: 0;
                margin-bottom: 0.5rem;
            }
            .input-area {
                border: 1px dashed #cccccc;
                background-color: #ffffff;
                padding: 1rem;
                min-height: auto;
            }
            .feedback-category, .overview-category, .corrected-section {
                page-break-inside: avoid;
                border-left-width: 5px !important;
                background-color: #ffffff !important;
                color: #000000 !important;
                box-shadow: none !important;
                margin-bottom: 15px !important;
                padding: 10px 15px !important;
                border-radius: 0 !important;
            }
            .grammar { border-left-color: #e74c3c !important; }
            .vocabulary { border-left-color: #3498db !important; }
            .expression { border-left-color: #9b59b6 !important; }
            .strengths { border-left-color: #2ecc71 !important; }
            .overview-category { border-left-color: #8b5cf6 !important; }
            .corrected-section { border-left-color: #10b981 !important; }
            .original-text {
                background-color: #f8fafc !important;
                border-left: 3px solid #94a3b8 !important;
                padding: 10px !important;
                margin: 10px 0 !important;
                font-style: italic !important;
            }
            .feedback-category h3, .overview-category h3, .corrected-section h3 {
                font-weight: bold !important;
                margin-top: 0 !important;
                margin-bottom: 10px !important;
            }
            .edit-instruction {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div id="container">
        <div class="header-section">
            <h1>âœ¨ ìœ¤ì„ ìƒ ë¦¬ì–¼ìŠ¤í”¼ì¹˜ WriteBack âœ¨</h1>
            <button id="reset-btn">Reset</button>
        </div>

        <nav>
            <button id="tab-feedback" class="tab-base tab-feedback active">í”¼ë“œë°± ë°›ê¸°</button>
            <button id="tab-final" class="tab-base tab-final">ìµœì¢… ê²°ê³¼ë¬¼ ìƒì„±</button>
        </nav>

        <section id="feedback-section" class="section active">
            <form id="feedback-form">
                <label for="contentText-feedback">â‡ï¸ì˜ì‘í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ì°ì–´ì„œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</label>
                <div class="user-info">
                    <input type="text" id="user-name-feedback" placeholder="ì´ë¦„" />
                    <input type="text" id="user-school-feedback" placeholder="í•™êµ(í•™ë…„)" />
                </div>
                <div class="action-icons">
                    <div class="icon-btn-container">
                        <button type="button" class="icon-btn" title="ì‚¬ì§„ ì´¬ì˜">ğŸ“¸
                            <input type="file" id="contentFile-camera-feedback" accept="image/*" capture="environment" />
                        </button>
                        <span class="icon-btn-label">ì‚¬ì§„ ì´¬ì˜</span>
                    </div>
                    <div class="icon-btn-container">
                        <button type="button" class="icon-btn" title="ì´ë¯¸ì§€ ì„ íƒ">ğŸ–¼ï¸
                            <input type="file" id="contentFile-gallery-feedback" accept="image/*" />
                        </button>
                        <span class="icon-btn-label">ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>
                    </div>
                </div>
                <textarea id="contentText-feedback" class="input-area" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                <div class="file-info" id="file-info-feedback"><span class="file-name"></span></div>
                <div class="ocr-status" id="ocr-status-feedback">
                    <div class="spinner"></div><span>ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤...</span>
                </div>
                <button type="submit" id="submit-feedback-btn">í”¼ë“œë°± ë°›ê¸° <span id="submit-spinner-feedback"
                        class="spinner"></span></button>
            </form>
            <div id="feedback-result"></div>
        </section>

        <section id="final-section" class="section">
            <form id="final-form">
                <label for="contentText-final">â‡ï¸ìµœì¢… ê²°ê³¼ë¬¼ì„ ìœ„í•´ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì°ì–´ì„œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</label>
                <div class="user-info">
                    <input type="text" id="user-name-final" placeholder="ì´ë¦„" />
                    <input type="text" id="user-school-final" placeholder="í•™êµ" />
                </div>
                <div class="action-icons">
                    <div class="icon-btn-container">
                        <button type="button" class="icon-btn" title="ì‚¬ì§„ ì´¬ì˜">ğŸ“¸
                            <input type="file" id="contentFile-camera-final" accept="image/*" capture="environment" />
                        </button>
                        <span class="icon-btn-label">ì‚¬ì§„ ì´¬ì˜</span>
                    </div>
                    <div class="icon-btn-container">
                        <button type="button" class="icon-btn" title="ì´ë¯¸ì§€ ì„ íƒ">ğŸ–¼ï¸
                            <input type="file" id="contentFile-gallery-final" accept="image/*" />
                        </button>
                        <span class="icon-btn-label">ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>
                    </div>
                </div>
                <textarea id="contentText-final" class="input-area" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                <div class="file-info" id="file-info-final"><span class="file-name"></span></div>
                <div class="ocr-status" id="ocr-status-final">
                    <div class="spinner"></div><span>ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤...</span>
                </div>
                <button type="submit" id="submit-final-btn">ìµœì¢… ê²°ê³¼ ìƒì„± <span id="submit-spinner-final"
                        class="spinner"></span></button>
            </form>
            <div id="final-result"></div>
        </section>
    </div>

    <script>
        const WORKER_URL = 'https://writing-feedback-app.sehyunglee2015.workers.dev';
        const PROXY_URL = WORKER_URL + '/proxy';
        window.feedbackFileURL = '';
        window.finalFileURL = '';
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ í”Œë˜ê·¸
        let eventListenersAttached = false;

        // í˜ì´ì§€ ë©ˆì¶¤ í˜„ìƒ ë°©ì§€ë¥¼ ìœ„í•œ ì•ˆì „ ì¥ì¹˜
        function safeExecute(fn, fallback) {
            try {
                return fn();
            } catch (error) {
                console.error('í•¨ìˆ˜ ì‹¤í–‰ ì˜¤ë¥˜:', error);
                if (fallback) fallback();
                return null;
            }
        }

        // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•œ ì •ë¦¬ í•¨ìˆ˜
        function cleanupEventListeners() {
            const elements = ['reset-btn', 'tab-feedback', 'tab-final'];
            elements.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.onclick = null;
                }
            });
        }

        // Reset ê¸°ëŠ¥
        function setupResetButton() {
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn && !resetBtn.onclick) {
                resetBtn.onclick = () => safeExecute(() => {
                    ['feedback', 'final'].forEach(sec => {
                        const textArea = document.getElementById(`contentText-${sec}`);
                        const fileInfo = document.getElementById(`file-info-${sec}`);
                        const ocrStatus = document.getElementById(`ocr-status-${sec}`);
                        const userName = document.getElementById(`user-name-${sec}`);
                        const userSchool = document.getElementById(`user-school-${sec}`);
                        const result = document.getElementById(`${sec}-result`) || document.getElementById(`${sec === 'feedback' ? 'feedback-result' : 'final-result'}`);
                        
                        if (textArea) textArea.value = '';
                        if (fileInfo) fileInfo.classList.remove('show');
                        if (ocrStatus) ocrStatus.classList.remove('show');
                        if (textArea) textArea.classList.remove('has-image');
                        if (userName) userName.value = '';
                        if (userSchool) userSchool.value = '';
                        if (result) result.innerHTML = '';
                    });
                    window.feedbackFileURL = '';
                    window.finalFileURL = '';
                });
            }
        }

        // íƒ­ ì „í™˜ ê¸°ëŠ¥
        function setupTabSwitching() {
            const feedbackTab = document.getElementById('tab-feedback');
            const finalTab = document.getElementById('tab-final');
            
            if (feedbackTab && !feedbackTab.onclick) {
                feedbackTab.onclick = () => safeExecute(() => {
                    document.getElementById('feedback-section').classList.add('active');
                    feedbackTab.classList.add('active');
                    document.getElementById('final-section').classList.remove('active', 'final-theme');
                    finalTab.classList.remove('active');
                });
            }
            
            if (finalTab && !finalTab.onclick) {
                finalTab.onclick = () => safeExecute(() => {
                    document.getElementById('final-section').classList.add('active', 'final-theme');
                    finalTab.classList.add('active');
                    document.getElementById('feedback-section').classList.remove('active');
                    feedbackTab.classList.remove('active');
                });
            }
        }

        // EXIF ë°ì´í„° ì½ê¸° í•¨ìˆ˜
        function getImageOrientation(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const view = new DataView(e.target.result);
                    if (view.getUint16(0, false) !== 0xFFD8) {
                        resolve(1);
                        return;
                    }
                    const length = view.byteLength;
                    let offset = 2;
                    while (offset < length) {
                        const marker = view.getUint16(offset, false);
                        offset += 2;
                        if (marker === 0xFFE1) {
                            const exifOffset = offset + 4;
                            if (view.getUint32(exifOffset, false) === 0x45786966) {
                                const tiffOffset = exifOffset + 6;
                                const firstIFDOffset = view.getUint32(tiffOffset + 4, true) + tiffOffset;
                                const entryCount = view.getUint16(firstIFDOffset, true);
                                for (let i = 0; i < entryCount; i++) {
                                    const entryOffset = firstIFDOffset + 2 + (i * 12);
                                    if (view.getUint16(entryOffset, true) === 0x0112) {
                                        resolve(view.getUint16(entryOffset + 8, true));
                                        return;
                                    }
                                }
                            }
                        }
                        offset += view.getUint16(offset, false);
                    }
                    resolve(1);
                };
                reader.readAsArrayBuffer(file.slice(0, 64 * 1024));
            });
        }

        // ì´ë¯¸ì§€ íšŒì „ í•¨ìˆ˜
        function rotateImageBasedOnOrientation(canvas, ctx, orientation) {
            const { width, height } = canvas;
            
            switch (orientation) {
                case 3: // 180ë„ íšŒì „
                    ctx.transform(-1, 0, 0, -1, width, height);
                    break;
                case 6: // 90ë„ ì‹œê³„ë°©í–¥ íšŒì „
                    canvas.width = height;
                    canvas.height = width;
                    ctx.transform(0, 1, -1, 0, height, 0);
                    break;
                case 8: // 90ë„ ë°˜ì‹œê³„ë°©í–¥ íšŒì „
                    canvas.width = height;
                    canvas.height = width;
                    ctx.transform(0, -1, 1, 0, 0, width);
                    break;
                default:
                    return false; // íšŒì „ ë¶ˆí•„ìš”
            }
            return true;
        }

        // í…ìŠ¤íŠ¸ ì •ë¦¬ í•¨ìˆ˜
        function cleanExtractedText(text) {
            if (!text || typeof text !== 'string') {
                return '';
            }
            
            // 1. ìˆ«ì ë¦¬ìŠ¤íŠ¸ ì œê±° (ì˜ˆ: "1.", "2.", "3." ë“±)
            text = text.replace(/^\s*\d+\.\s*/gm, '');
            
            // 2. ì—°ì†ëœ ê³µë°±ì„ í•˜ë‚˜ë¡œ ì •ë¦¬
            text = text.replace(/[ \t]+/g, ' ');
            
            // 3. 3ê°œ ì´ìƒì˜ ì—°ì† ì¤„ë°”ê¿ˆì„ 2ê°œë¡œ
            text = text.replace(/\n{3,}/g, '\n\n');
            
            // 4. ê° ì¤„ì˜ ì•ë’¤ ê³µë°± ì œê±°
            text = text.split('\n').map(line => line.trim()).join('\n');
            
            // 5. ë¹ˆ ì¤„ì´ ë„ˆë¬´ ë§ì€ ê²½ìš° ì •ë¦¬
            text = text.replace(/(\n\s*){3,}/g, '\n\n');
            
            // 6. ë¬¸ì¥ ëì˜ ë¶ˆí•„ìš”í•œ ê³µë°± ì •ë¦¬
            text = text.replace(/\.\s{2,}/g, '. ');
            text = text.replace(/\?\s{2,}/g, '? ');
            text = text.replace(/!\s{2,}/g, '! ');
            
            return text.trim();
        }

        // ì´ë¯¸ì§€ ì „ì²˜ë¦¬ í•¨ìˆ˜
        function preprocessImage(canvas, ctx) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const contrast = 1.2;
            const brightness = 10;
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, contrast * (data[i] - 128) + 128 + brightness));
                data[i + 1] = Math.min(255, Math.max(0, contrast * (data[i + 1] - 128) + 128 + brightness));
                data[i + 2] = Math.min(255, Math.max(0, contrast * (data[i + 2] - 128) + 128 + brightness));
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        // OCR í•¨ìˆ˜
        async function doOCR(file, section) {
            const status = document.getElementById(`ocr-status-${section}`);
            const textArea = document.getElementById(`contentText-${section}`);
            
            if (!status || !textArea) return;
            
            status.classList.add('show');
            
            try {
                if (file.size > 10 * 1024 * 1024) {
                    throw new Error('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                }
                
                if (!file.type.startsWith('image/')) {
                    throw new Error('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }

                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                await new Promise((resolve) => {
                    img.onload = resolve;
                    img.src = URL.createObjectURL(file);
                });
                
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                // ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì ìš©
                preprocessImage(canvas, ctx);
                
                const processedDataUrl = canvas.toDataURL('image/jpeg', 0.95);
                const b64 = processedDataUrl.split(',')[1];
                
                const requestBody = {
                    model: 'gpt-4o-mini',
                    messages: [{
                        role: 'user',
                        content: [{
                            type: 'text',
                            text: `ì´ ì´ë¯¸ì§€ì—ì„œ ì˜ì–´ í…ìŠ¤íŠ¸ë¥¼ ì •í™•íˆ ì¶”ì¶œí•´ì£¼ì„¸ìš”. ë‹¤ìŒ ê·œì¹™ì„ ë”°ë¼ì£¼ì„¸ìš”:
1. ì´ë¯¸ì§€ì— ìˆëŠ” ëª¨ë“  ì˜ì–´ í…ìŠ¤íŠ¸ë¥¼ ìˆœì„œëŒ€ë¡œ ì¶”ì¶œ
2. ì¤„ë°”ê¿ˆê³¼ ë¬¸ë‹¨ êµ¬ì¡° ìœ ì§€
3. ì˜¤íƒ€ë‚˜ ì¶”ì¸¡í•˜ì§€ ë§ê³  ë³´ì´ëŠ” ê·¸ëŒ€ë¡œ ì •í™•íˆ ì…ë ¥
4. ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ì½”ë©˜íŠ¸ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ ë°˜í™˜
5. ë¶ˆëª…í™•í•œ ê¸€ìëŠ” ê°€ì¥ ìœ ì‚¬í•œ ì˜ì–´ ë‹¨ì–´ë¡œ ì¶”ì •
6. ìˆ«ì ë¦¬ìŠ¤íŠ¸ë‚˜ ë¶ˆí•„ìš”í•œ ê¸°í˜¸ëŠ” ì œì™¸`
                        }, {
                            type: 'image_url',
                            image_url: { url: processedDataUrl }
                        }]
                    }],
                    max_tokens: 1500,
                    temperature: 0.1
                };
                
                const resp = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!resp.ok) {
                    throw new Error(`API ì˜¤ë¥˜: ${resp.status}`);
                }
                
                const data = await resp.json();
                const extractedText = data.choices?.[0]?.message?.content?.trim() || '';
                
                if (extractedText) {
                    const cleanedText = cleanExtractedText(extractedText);
                    textArea.value = cleanedText;
                } else {
                    textArea.value = 'í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ê°€ ì„ ëª…í•œì§€ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                }
                
            } catch (error) {
                console.error('OCR ì˜¤ë¥˜:', error);
                let userMessage = 'ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                
                if (error.message.includes('ë„¤íŠ¸ì›Œí¬')) {
                    userMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message.includes('íŒŒì¼')) {
                    userMessage = error.message;
                } else if (error.message.includes('API')) {
                    userMessage = error.message;
                } else {
                    userMessage = 'í…ìŠ¤íŠ¸ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì‹œë„í•´ë³´ê±°ë‚˜ ì§ì ‘ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                }
                
                textArea.value = userMessage;
                
                setTimeout(() => {
                    alert(userMessage + '\n\nì§ì ‘ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.');
                }, 100);
                
            } finally {
                status.classList.remove('show');
            }
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ì„¤ì •
        function setupFileUpload() {
            ['feedback', 'final'].forEach(section => {
                ['camera', 'gallery'].forEach(src => {
                    const fileInput = document.getElementById(`contentFile-${src}-${section}`);
                    if (fileInput && !fileInput.onchange) {
                        fileInput.onchange = (e) => safeExecute(async () => {
                            const file = e.target.files[0];
                            if (!file) return;
                            
                            const url = URL.createObjectURL(file);
                            window[`${section}FileURL`] = url;
                            const info = document.getElementById(`file-info-${section}`);
                            if (info) {
                                info.querySelector('.file-name').textContent = file.name;
                                info.classList.add('show');
                            }
                            const textArea = document.getElementById(`contentText-${section}`);
                            if (textArea) textArea.classList.add('has-image');
                            
                            await doOCR(file, section);
                        });
                    }
                });
            });
        }

        // í”¼ë“œë°± í…ìŠ¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜
        function processFeedback(feedback, originalText) {
            const originalLines = originalText.trim().split(/\n+/);
            
            const overviewPattern = /(?:ì´í‰|ì „ì²´\s*í‰ê°€|ì¢…í•©\s*í‰ê°€)[\s]*:[\s\S]*?(?=(?:ë¬¸ë²•\s*ì˜¤ë¥˜|ì–´íœ˜\s*ê°œì„ |í‘œí˜„\s*í–¥ìƒ|ì˜í•œ\s*ì )\s*:|$)/i;
            const grammarPattern = /ë¬¸ë²•\s*ì˜¤ë¥˜\s*:[\s\S]*?(?=(?:ì´í‰|ì „ì²´\s*í‰ê°€|ì¢…í•©\s*í‰ê°€|ì–´íœ˜\s*ê°œì„ |í‘œí˜„\s*í–¥ìƒ|ì˜í•œ\s*ì )\s*:|$)/i;
            const vocabPattern = /ì–´íœ˜\s*ê°œì„ \s*:[\s\S]*?(?=(?:ì´í‰|ì „ì²´\s*í‰ê°€|ì¢…í•©\s*í‰ê°€|ë¬¸ë²•\s*ì˜¤ë¥˜|í‘œí˜„\s*í–¥ìƒ|ì˜í•œ\s*ì )\s*:|$)/i;
            const expressionPattern = /í‘œí˜„\s*í–¥ìƒ\s*:[\s\S]*?(?=(?:ì´í‰|ì „ì²´\s*í‰ê°€|ì¢…í•©\s*í‰ê°€|ë¬¸ë²•\s*ì˜¤ë¥˜|ì–´íœ˜\s*ê°œì„ |ì˜í•œ\s*ì )\s*:|$)/i;
            const strengthsPattern = /ì˜í•œ\s*ì \s*:[\s\S]*?(?=(?:ì´í‰|ì „ì²´\s*í‰ê°€|ì¢…í•©\s*í‰ê°€|ë¬¸ë²•\s*ì˜¤ë¥˜|ì–´íœ˜\s*ê°œì„ |í‘œí˜„\s*í–¥ìƒ)\s*:|$)/i;
            
            let html = '<div class="feedback-container">';
            
            // ì´í‰ ì„¹ì…˜
            const overview = feedback.match(overviewPattern);
            if (overview && overview[0].trim().length > 0) {
                const overviewContent = overview[0].replace(/(?:ì´í‰|ì „ì²´\s*í‰ê°€|ì¢…í•©\s*í‰ê°€)\s*:/i, '').trim();
                if (overviewContent) {
                    // ë¶ˆí•„ìš”í•œ ìˆ«ì ì œê±°
                    const cleanedOverview = cleanExtractedText(overviewContent);
                    html += `
                        <div class="overview-category">
                            <h3><i class="fas fa-star"></i> ì´í‰</h3>
                            <div class="content">${cleanedOverview.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }
            }
            
            // ê° ì¹´í…Œê³ ë¦¬ë³„ ì²˜ë¦¬
            const categories = [
                { name: 'ë¬¸ë²• ì˜¤ë¥˜', pattern: grammarPattern, class: 'grammar', icon: 'fas fa-exclamation-circle' },
                { name: 'ì–´íœ˜ ê°œì„ ', pattern: vocabPattern, class: 'vocabulary', icon: 'fas fa-book' },
                { name: 'í‘œí˜„ í–¥ìƒ', pattern: expressionPattern, class: 'expression', icon: 'fas fa-pencil-alt' },
                { name: 'ì˜í•œ ì ', pattern: strengthsPattern, class: 'strengths', icon: 'fas fa-thumbs-up' }
            ];
            
            categories.forEach(category => {
                const match = feedback.match(category.pattern);
                if (match && match[0].trim().length > 0) {
                    const content = match[0].replace(new RegExp(`${category.name.replace('ì ', '\\s*ì ')}\\s*:`, 'i'), '').trim();
                    if (content) {
                        const cleanedContent = cleanExtractedText(content);
                        const points = extractFeedbackPoints(cleanedContent, originalLines);
                        
                        html += `
                            <div class="feedback-category ${category.class}">
                                <h3><i class="${category.icon}"></i> ${category.name}</h3>
                                ${points}
                            </div>
                        `;
                    }
                }
            });
            
            html += '</div>';
            return html;
        }

        // í”¼ë“œë°± í¬ì¸íŠ¸ ì¶”ì¶œ í•¨ìˆ˜
        function extractFeedbackPoints(content, originalLines) {
            const points = content.split(/\n\s*\n+/).filter(p => p.trim());
            let html = '';
            
            points.forEach(point => {
                const cleanPoint = cleanExtractedText(point);
                const englishQuotes = cleanPoint.match(/["']([^"']+)["']|`([^`]+)`|\b([A-Za-z][\w\s,.!?;:'"()-]*?[.!?])\b/g);
                
                let originalTextFound = '';
                
                if (englishQuotes && englishQuotes.length > 0) {
                    const cleanQuotes = englishQuotes.map(q => q.replace(/^["'`]|["'`]$/g, '').trim());
                    
                    for (const line of originalLines) {
                        for (const quote of cleanQuotes) {
                            if (quote.length > 3 && line.includes(quote)) {
                                originalTextFound = line.trim();
                                break;
                            }
                        }
                        if (originalTextFound) break;
                    }
                }
                
                html += `
                    ${originalTextFound ? `<div class="original-text">${originalTextFound}</div>` : ''}
                    <div class="feedback-point">${cleanPoint.replace(/\n/g, '<br>')}</div>
                    <hr style="border: 0; height: 1px; background-color: #e2e8f0; margin: 10px 0;">
                `;
            });
            
            html = html.replace(/<hr[^>]*>$/i, '');
            return html;
        }

        // Edit/Save ë²„íŠ¼ í† ê¸€ ê¸°ëŠ¥
        function setupEditSaveToggle(contentId, containerId) {
            const content = document.getElementById(contentId);
            const container = document.getElementById(containerId);
            
            if (!content || !container) return;
            
            content.setAttribute('contenteditable', 'false');
            
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.className = 'edit-save-btn';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'btn-group';
            wrapper.appendChild(editBtn);
            container.appendChild(wrapper);
            
            editBtn.onclick = () => safeExecute(() => {
                const isEditing = content.getAttribute('contenteditable') === 'true';
                
                if (isEditing) {
                    content.setAttribute('contenteditable', 'false');
                    editBtn.textContent = 'Edit';
                    editBtn.style.backgroundColor = '#64748b';
                    content.style.border = 'none';
                    content.style.backgroundColor = 'transparent';
                } else {
                    content.setAttribute('contenteditable', 'true');
                    editBtn.textContent = 'Save';
                    editBtn.style.backgroundColor = '#16a34a';
                    content.style.border = '2px dashed #16a34a';
                    content.style.backgroundColor = '#f0fdf4';
                    content.focus();
                }
            });
        }

        // ìˆ˜ì •ê¸€ í…ìŠ¤íŠ¸ í¬ë§·íŒ…
        function formatCorrectedText(text) {
            let formatted = text.replace(/\n/g, '<br>');
            formatted = formatted.replace(/\(([^)]+)\)/g, '(<span class="highlight">$1</span>)');
            formatted = formatted.replace(/\*([^*]+)\*/g, '<span class="highlight">$1</span>');
            return formatted;
        }

        // PDF íŒŒì¼ëª… ìƒì„±
        function generatePDFFileName(userName) {
            const today = new Date();
            const dateStr = today.getFullYear() + 
                           String(today.getMonth() + 1).padStart(2, '0') + 
                           String(today.getDate()).padStart(2, '0');
            
            if (userName && userName.trim()) {
                return `${userName.trim()}_ë¦¬ì–¼ìŠ¤í”¼ì¹˜_${dateStr}`;
            } else {
                return `WriteBack_${dateStr}`;
            }
        }

        // ì¸ì‡„ìš© ì´ë¯¸ì§€ íšŒì „ í•¨ìˆ˜
        function getRotatedImageForPrint(imageUrl, callback) {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const isLandscape = img.width > img.height;
                
                if (isLandscape) {
                    canvas.width = img.height;
                    canvas.height = img.width;
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(90 * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2);
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                }
                
                const rotatedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                callback(rotatedDataUrl);
            };
            img.src = imageUrl;
        }

        // ì¸ì‡„ HTML ìƒì„± í•¨ìˆ˜
        function generateAndPrintHTML(imageUrl, orig, fbCheck, corr, name, school, type) {
            const fileName = generatePDFFileName(name);
            
            let html = `<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>${fileName}</title>
    <style>
        @page {
            margin: 15mm;
            size: A4;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: white;
            color: black;
            line-height: 1.4;
        }
        
        .print-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            border-bottom: 3px solid #1e3a8a;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .print-header .logo {
            height: 60px;
            margin-bottom: 10px;
        }
        
        .print-header .title {
            font-size: 28px;
            font-weight: bold;
            color: #1e3a8a;
            margin: 0;
            text-align: center;
            letter-spacing: 1px;
        }
        
        .content-section {
            margin-bottom: 8px;
        }
        
        .content-section h2 {
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 18px;
            color: #1e3a8a;
        }
        
        .content-section p, .content-section div {
            margin-bottom: 6px;
            margin-top: 0;
        }
        
        .feedback-category, .overview-category, .corrected-section {
            margin-bottom: 8px;
            padding: 8px 12px;
            page-break-inside: avoid;
            border-left-width: 5px;
            border-left-style: solid;
        }
        
        .overview-category {
            border-left-color: #8b5cf6;
            background-color: #f5f3ff;
        }
        
        .grammar { border-left-color: #e74c3c; background-color: #fdeded; }
        .vocabulary { border-left-color: #3498db; background-color: #ebf5fb; }
        .expression { border-left-color: #9b59b6; background-color: #f4ecf7; }
        .strengths { border-left-color: #2ecc71; background-color: #ebfaf0; }
        .corrected-section { border-left-color: #10b981; background-color: #ecfdf5; }
        
        .original-text {
            margin: 4px 0;
            padding: 6px 10px;
            background-color: rgba(248, 250, 252, 0.8);
            border-left: 3px solid #94a3b8;
            font-style: italic;
            color: #475569;
        }
        
        .original-text::before {
            content: 'ì›ë¬¸';
            display: block;
            font-weight: 600;
            font-style: normal;
            font-size: 0.85rem;
            margin-bottom: 5px;
            color: #64748b;
        }
        
        .feedback-point {
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        hr {
            margin: 3px 0;
            border: 0;
            height: 1px;
            background-color: #e2e8f0;
        }
        
        img {
            max-width: 100%;
            height: auto;
            page-break-inside: avoid;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        h3 {
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="print-header">
        <img src="https://page1.genspark.site/v1/base64_upload/78cc0523b080d22fe6d247fc2d9bf3c4" alt="ìœ¤ì„ ìƒ ë¡œê³ " class="logo">
        <h1 class="title">ìœ¤ì„ ìƒ ë¦¬ì–¼ìŠ¤í”¼ì¹˜ 2025</h1>
    </div>
    
    <div class="print-content">`;
    
            // ì‚¬ìš©ì ì •ë³´ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ
            if (name?.trim() || school?.trim()) {
                html += `<div class="content-section user-info" style="margin-bottom: 15px; padding: 8px; background-color: #f8fafc; border-radius: 4px;">`;
                if (name?.trim()) html += `<strong>ì´ë¦„:</strong> ${name.trim()}`;
                if (name?.trim() && school?.trim()) html += ` &nbsp;&nbsp; `;
                if (school?.trim()) html += `<strong>í•™êµ:</strong> ${school.trim()}`;
                html += `</div>`;
            }
            
            // ì›ë³¸ ë‚´ìš©
            if (orig) {
                html += '<div class="content-section"><h2>ì›ë³¸</h2>';
                if (imageUrl) {
                    html += `<div style="margin: 10px 0;"><img src="${imageUrl}" alt="ì›ë³¸ ì´ë¯¸ì§€" /></div>`;
                } else {
                    const textContent = type === 'feedback' ? 
                        document.getElementById('contentText-feedback')?.value || '' : 
                        document.getElementById('contentText-final')?.value || '';
                    html += `<div style="white-space: pre-wrap; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8fafc;">${textContent}</div>`;
                }
                html += '</div>';
            }
            
            // í”¼ë“œë°± ë‚´ìš©
            if (fbCheck && type === 'feedback') {
                const feedbackContent = document.getElementById('fb-content');
                if (feedbackContent) {
                    html += '<div class="content-section"><h2>í”¼ë“œë°±</h2>' + feedbackContent.outerHTML + '</div>';
                }
            }
            
            // ìˆ˜ì •ê¸€ ë‚´ìš©
            if (corr) {
                const correctedElement = type === 'feedback' ? 
                    document.getElementById('fb-corrected') : 
                    document.getElementById('fn-corrected');
                
                if (correctedElement) {
                    html += '<div class="content-section"><h2>ìˆ˜ì •ê¸€</h2>';
                    html += `<div class="corrected-section">`;
                    html += `<div style="background-color: #ffffff; padding: 12px; border-radius: 6px; line-height: 1.6; border: 1px solid #d1fae5;">${correctedElement.innerHTML}</div>`;
                    html += '</div></div>';
                }
            }
            
            html += `
    </div>
    <script>
        document.title = "${fileName}";
        window.onload = function() {
            setTimeout(() => {
                window.print();
                window.onafterprint = function() {
                    window.close();
                };
            }, 1000);
        };
    </script>
</body>
</html>`;
            
            try {
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (!printWindow) {
                    alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                printWindow.document.open();
                printWindow.document.write(html);
                printWindow.document.close();
            } catch (error) {
                console.error('ì¸ì‡„ ì˜¤ë¥˜:', error);
                alert('ì¸ì‡„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // í”¼ë“œë°± í¼ ì œì¶œ
        function setupFeedbackForm() {
            const form = document.getElementById('feedback-form');
            if (form && !form.onsubmit) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    return safeExecute(async () => {
                        const contentText = document.getElementById('contentText-feedback').value.trim();
                        if (!contentText) {
                            alert("ì˜ì‘í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ ì‹¤í–‰í•´ì£¼ì„¸ìš”!");
                            return;
                        }
                        
                        const btn = document.getElementById('submit-feedback-btn');
                        const sp = document.getElementById('submit-spinner-feedback');
                        
                        if (btn) btn.disabled = true;
                        if (sp) sp.style.display = 'inline-block';
                        
                        try {
                            const res = await fetch(`${WORKER_URL}/api/feedback`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contentText })
                            });
                            
                            const { feedback, modelAnswer } = await res.json();
                            const container = document.getElementById('feedback-result');
                            
                            const formattedFeedback = processFeedback(feedback, contentText);
                            
                            if (container) {
                                container.innerHTML = `
                                    <p style="text-align: left;">
                                        ğŸ“¢ AIëŠ” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¼­ ìƒì„±ëœ ë‚´ìš©ì„ í™•ì¸ í›„ í•„ìš”í•œ ë¶€ë¶„ì€ ìˆ˜ì •í•˜ì…”ì„œ ì´ìš©í•´ì£¼ì„¸ìš”~!
                                    </p>
                                    <div class="box" id="fb-box">
                                        <h2>í”¼ë“œë°±</h2>
                                        <div class="edit-instruction">
                                            ğŸ’¡ ë‚´ìš©ì—ì„œ ì›í•˜ëŠ” ë¶€ë¶„ì„ ìˆ˜ì •í•˜ë ¤ë©´ Edit ë²„íŠ¼ì„ ëˆ„ë¥¸ í›„ ì…ë ¥í•˜ì‹œê³  Saveë¥¼ ëˆŒëŸ¬ ì €ì¥í•´ì£¼ì„¸ìš”.
                                        </div>
                                        <div id="fb-content">${formattedFeedback}</div>
                                    </div>
                                    <div class="corrected-section" id="fb-corr-box">
                                        <h3><i class="fas fa-check-circle"></i> ìˆ˜ì •ê¸€</h3>
                                        <div class="edit-instruction">
                                            ğŸ’¡ ë‚´ìš©ì—ì„œ ì›í•˜ëŠ” ë¶€ë¶„ì„ ìˆ˜ì •í•˜ë ¤ë©´ Edit ë²„íŠ¼ì„ ëˆ„ë¥¸ í›„ ì…ë ¥í•˜ì‹œê³  Saveë¥¼ ëˆŒëŸ¬ ì €ì¥í•´ì£¼ì„¸ìš”.
                                        </div>
                                        <div class="corrected-content" id="fb-corrected">${formatCorrectedText(modelAnswer)}</div>
                                    </div>
                                    <button id="print-feedback-btn">ì¸ì‡„</button>
                                    <div class="print-options-inline" id="print-options-feedback" style="display:none;">
                                        <label><input type="checkbox" id="print_orig_fb" checked> ì›ë³¸</label>
                                        <label><input type="checkbox" id="print_fb_fb" checked> í”¼ë“œë°±</label>
                                        <label><input type="checkbox" id="print_corr_fb" checked> ìˆ˜ì •ê¸€</label>
                                        <button id="confirm-print-feedback-btn">Confirm</button>
                                    </div>
                                `;
                                
                                // Edit/Save ë²„íŠ¼ ì„¤ì •
                                setTimeout(() => {
                                    setupEditSaveToggle('fb-content', 'fb-box');
                                    setupEditSaveToggle('fb-corrected', 'fb-corr-box');
                                    
                                    // ì¸ì‡„ ë²„íŠ¼ ì´ë²¤íŠ¸
                                    const printBtn = document.getElementById('print-feedback-btn');
                                    const confirmBtn = document.getElementById('confirm-print-feedback-btn');
                                    
                                    if (printBtn) {
                                        printBtn.onclick = () => {
                                            const options = document.getElementById('print-options-feedback');
                                            if (options) options.style.display = 'flex';
                                        };
                                    }
                                    
                                    if (confirmBtn) {
                                        confirmBtn.onclick = () => safeExecute(() => {
                                            const orig = document.getElementById('print_orig_fb')?.checked;
                                            const fbCheck = document.getElementById('print_fb_fb')?.checked;
                                            const corr = document.getElementById('print_corr_fb')?.checked;
                                            const name = document.getElementById('user-name-feedback')?.value;
                                            const school = document.getElementById('user-school-feedback')?.value;
                                            
                                            const options = document.getElementById('print-options-feedback');
                                            if (options) options.style.display = 'none';
                                            
                                            if (orig && window.feedbackFileURL && window.feedbackFileURL.startsWith('blob:')) {
                                                getRotatedImageForPrint(window.feedbackFileURL, (rotatedImageUrl) => {
                                                    generateAndPrintHTML(rotatedImageUrl, orig, fbCheck, corr, name, school, 'feedback');
                                                });
                                            } else {
                                                generateAndPrintHTML(window.feedbackFileURL, orig, fbCheck, corr, name, school, 'feedback');
                                            }
                                        });
                                    }
                                }, 100);
                            }
                        } catch (e) {
                            alert('í”¼ë“œë°± ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        } finally {
                            if (btn) btn.disabled = false;
                            if (sp) sp.style.display = 'none';
                        }
                    });
                };
            }
        }

        // ìµœì¢… ê²°ê³¼ í¼ ì œì¶œ
        function setupFinalForm() {
            const form = document.getElementById('final-form');
            if (form && !form.onsubmit) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    return safeExecute(async () => {
                        const contentText = document.getElementById('contentText-final').value.trim();
                        if (!contentText) {
                            alert("ì˜ì‘í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ ì‹¤í–‰í•´ì£¼ì„¸ìš”!");
                            return;
                        }
                        
                        const btn = document.getElementById('submit-final-btn');
                        const sp = document.getElementById('submit-spinner-final');
                        
                        if (btn) btn.disabled = true;
                        if (sp) sp.style.display = 'inline-block';
                        
                        try {
                            const res = await fetch(`${WORKER_URL}/api/feedback`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contentText })
                            });
                            
                            const { feedback, modelAnswer } = await res.json();
                            const cont = document.getElementById('final-result');
                            
                            if (cont) {
                                cont.innerHTML = `
                                    <p style="text-align: left;">
                                        ğŸ“¢ AIëŠ” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¼­ ìƒì„±ëœ ë‚´ìš©ì„ í™•ì¸ í›„ í•„ìš”í•œ ë¶€ë¶„ì€ ìˆ˜ì •í•˜ì…”ì„œ ì´ìš©í•´ì£¼ì„¸ìš”~!
                                    </p>
                                    <div class="corrected-section" id="fn-box">
                                        <h3><i class="fas fa-check-circle"></i> ìˆ˜ì •ê¸€</h3>
                                        <div class="edit-instruction">
                                            ğŸ’¡ ë‚´ìš©ì—ì„œ ì›í•˜ëŠ” ë¶€ë¶„ì„ ìˆ˜ì •í•˜ë ¤ë©´ Edit ë²„íŠ¼ì„ ëˆ„ë¥¸ í›„ ì…ë ¥í•˜ì‹œê³  Saveë¥¼ ëˆŒëŸ¬ ì €ì¥í•´ì£¼ì„¸ìš”.
                                        </div>
                                        <div class="corrected-content" id="fn-corrected">${formatCorrectedText(modelAnswer)}</div>
                                    </div>
                                    <div class="btn-group" id="fn-edit-group"></div>
                                    <div class="audio-controls-area">
                                        <button id="tts-play-btn">ì›ì–´ë¯¼ ìŒì„± ë“£ê¸°</button><span id="tts-spinner" class="spinner"></span>
                                        <audio id="tts-audio-final" controls style="display:none;"></audio>
                                        <a id="tts-download-btn" style="display:none;">ìŒì› ë‹¤ìš´ë¡œë“œ</a>
                                    </div>
                                    <div class="print-button-bottom">
                                        <a id="print-final-btn" class="button">ì¸ì‡„</a>
                                    </div>
                                    <div class="print-options-inline" id="print-options-final" style="display:none;">
                                        <label><input type="checkbox" id="print_orig_fn" checked> ì›ë³¸</label>
                                        <label><input type="checkbox" id="print_corr_fn" checked> ìˆ˜ì •ê¸€</label>
                                        <button id="confirm-print-final-btn">Confirm</button>
                                    </div>
                                `;
                                
                                // Edit/Save ë²„íŠ¼ ì„¤ì •
                                setTimeout(() => {
                                    setupEditSaveToggle('fn-corrected', 'fn-box');
                                    
                                    // TTS ê¸°ëŠ¥
                                    const playBtn = document.getElementById('tts-play-btn');
                                    const spinner = document.getElementById('tts-spinner');
                                    const dl = document.getElementById('tts-download-btn');
                                    const audio = document.getElementById('tts-audio-final');
                                    
                                    if (playBtn) {
                                        playBtn.onclick = async () => safeExecute(async () => {
                                            playBtn.disabled = true;
                                            if (spinner) spinner.style.display = 'inline-block';
                                            
                                            try {
                                                const textFinal = document.getElementById('fn-corrected')?.innerText || '';
                                                const r = await fetch(`${WORKER_URL}/api/tts`, {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ text: textFinal })
                                                });
                                                const blob = await r.blob();
                                                const url = URL.createObjectURL(blob);
                                                
                                                if (audio) {
                                                    audio.src = url;
                                                    audio.style.display = 'block';
                                                }
                                                
                                                if (dl) {
                                                    dl.style.display = 'inline-block';
                                                    const userName = document.getElementById('user-name-final')?.value.trim() || 'writing';
                                                    dl.href = url;
                                                    dl.download = `${userName}.mp3`;
                                                }
                                            } catch (e) {
                                                alert('TTS ì—ëŸ¬: ' + e.message);
                                            } finally {
                                                playBtn.disabled = false;
                                                if (spinner) spinner.style.display = 'none';
                                            }
                                        });
                                    }
                                    
                                    // ì¸ì‡„ ê¸°ëŠ¥
                                    const printBtn = document.getElementById('print-final-btn');
                                    const confirmBtn = document.getElementById('confirm-print-final-btn');
                                    
                                    if (printBtn) {
                                        printBtn.onclick = () => {
                                            const options = document.getElementById('print-options-final');
                                            if (options) options.style.display = 'flex';
                                        };
                                    }
                                    
                                    if (confirmBtn) {
                                        confirmBtn.onclick = () => safeExecute(() => {
                                            const orig = document.getElementById('print_orig_fn')?.checked;
                                            const corr = document.getElementById('print_corr_fn')?.checked;
                                            const name = document.getElementById('user-name-final')?.value;
                                            const school = document.getElementById('user-school-final')?.value;
                                            
                                            const options = document.getElementById('print-options-final');
                                            if (options) options.style.display = 'none';
                                            
                                            if (orig && window.finalFileURL && window.finalFileURL.startsWith('blob:')) {
                                                getRotatedImageForPrint(window.finalFileURL, (rotatedImageUrl) => {
                                                    generateAndPrintHTML(rotatedImageUrl, orig, false, corr, name, school, 'final');
                                                });
                                            } else {
                                                generateAndPrintHTML(window.finalFileURL, orig, false, corr, name, school, 'final');
                                            }
                                        });
                                    }
                                }, 100);
                            }
                        } catch (e) {
                            alert('ìµœì¢… ê²°ê³¼ë¬¼ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        } finally {
                            if (btn) btn.disabled = false;
                            if (sp) sp.style.display = 'none';
                        }
                    });
                };
            }
        }

        // ì´ˆê¸°í™” í•¨ìˆ˜
        function initialize() {
            if (eventListenersAttached) return;
            
            safeExecute(() => {
                setupResetButton();
                setupTabSwitching();
                setupFileUpload();
                setupFeedbackForm();
                setupFinalForm();
                
                eventListenersAttached = true;
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        // í˜ì´ì§€ ì¬í™œì„±í™” ì‹œ ì•ˆì „ ì¥ì¹˜
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(() => {
                    if (!eventListenersAttached) {
                        initialize();
                    }
                }, 100);
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            cleanupEventListeners();
        });
    </script>
</body>

</html>
